!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.WebFields=t():e.WebFields=t()}(self,(()=>(()=>{"use strict";var e={38:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FieldFrameNumber=void 0;const n=r(979),a=r(853),i=r(234),s=r(382);class o extends n.FieldFrame{constructor(e,t,r){super(a.FieldType.Number,e,t,r)}onInitialized(){this.placeholder="Card Number"}validate(e){var t,r,n;const s=i.number(e),o=null!==(r=null===(t=s.card)||void 0===t?void 0:t.type)&&void 0!==r?r:a.CardType.Unknown;if(o!==this.cardType){if(o!==a.CardType.Unknown&&!1===this.config.limitCardTypes.includes(o))return{valid:!1,error:"Unsupported card type"};this.cardType=o,this.postFormMessage({type:"cardType",cardType:o})}return this.updateInputMask(s),{valid:!!s.isValid||!!s.isPotentiallyValid&&"maybe",error:s.isValid?void 0:void 0===(null===(n=s.card)||void 0===n?void 0:n.type)?"Invalid card number":`Invalid ${s.card.niceType} card number`,complete:s.isValid}}getFieldValueData(){return this.cardType}handleChannelCollectMessage(e){this.validate(this.input.value),e.data.cardType=this.cardType,super.handleChannelCollectMessage(e)}getInputMask(e){let t="";if(e){const r=e.lengths?Math.max(...e.lengths):16;let n=0;for(const r of e.gaps)t+="d".repeat(r-n)+" ",n=r;t+="d".repeat(r-n),t=t.trim()}return t}updateInputMask(e){var t;const r=this.getInputMask(e.card);this.lastPattern!==r&&(this.lastPattern=r,null===(t=this.removeSmask)||void 0===t||t.call(this),this.input.removeAttribute("maxLength"),this.input.removeAttribute("minLength"),r.length>0?this.removeSmask=s.input(this.input,[r]):this.removeSmask=void 0)}}t.FieldFrameNumber=o},57:(e,t,r)=>{r.r(t),r.d(t,{CompactEncrypt:()=>dt,CompactSign:()=>pt,EmbeddedJWK:()=>vt,EncryptJWT:()=>ft,FlattenedEncrypt:()=>$e,FlattenedSign:()=>lt,GeneralEncrypt:()=>Le,GeneralSign:()=>ht,SignJWT:()=>yt,UnsecuredJWT:()=>kt,base64url:()=>n,calculateJwkThumbprint:()=>wt,calculateJwkThumbprintUri:()=>gt,compactDecrypt:()=>We,compactVerify:()=>Ze,createLocalJWKSet:()=>At,createRemoteJWKSet:()=>Ot,cryptoRuntime:()=>Ft,customFetch:()=>Pt,decodeJwt:()=>Kt,decodeProtectedHeader:()=>Mt,errors:()=>a,exportJWK:()=>Je,exportPKCS8:()=>Ne,exportSPKI:()=>je,flattenedDecrypt:()=>Ue,flattenedVerify:()=>Xe,generalDecrypt:()=>_e,generalVerify:()=>qe,generateKeyPair:()=>Rt,generateSecret:()=>It,importJWK:()=>Ce,importPKCS8:()=>Ae,importSPKI:()=>Ee,importX509:()=>Se,jwksCache:()=>Tt,jwtDecrypt:()=>ct,jwtVerify:()=>ot});var n={};r.r(n),r.d(n,{decode:()=>y,encode:()=>f});var a={};r.r(a),r.d(a,{JOSEAlgNotAllowed:()=>v,JOSEError:()=>m,JOSENotSupported:()=>b,JWEDecryptionFailed:()=>E,JWEInvalid:()=>S,JWKInvalid:()=>P,JWKSInvalid:()=>T,JWKSMultipleMatchingKeys:()=>O,JWKSNoMatchingKey:()=>H,JWKSTimeout:()=>k,JWSInvalid:()=>A,JWSSignatureVerificationFailed:()=>M,JWTClaimValidationFailed:()=>w,JWTExpired:()=>g,JWTInvalid:()=>C});const i=new TextEncoder,s=new TextDecoder,o=2**32;function c(...e){const t=e.reduce(((e,{length:t})=>e+t),0),r=new Uint8Array(t);let n=0;for(const t of e)r.set(t,n),n+=t.length;return r}function d(e,t,r){if(t<0||t>=o)throw new RangeError(`value must be >= 0 and <= 4294967295. Received ${t}`);e.set([t>>>24,t>>>16,t>>>8,255&t],r)}function l(e){const t=Math.floor(e/o),r=e%o,n=new Uint8Array(8);return d(n,t,0),d(n,r,4),n}function p(e){const t=new Uint8Array(4);return d(t,e),t}function u(e){if(Uint8Array.prototype.toBase64)return e.toBase64();const t=[];for(let r=0;r<e.length;r+=32768)t.push(String.fromCharCode.apply(null,e.subarray(r,r+32768)));return btoa(t.join(""))}function h(e){if(Uint8Array.fromBase64)return Uint8Array.fromBase64(e);const t=atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return r}function y(e){if(Uint8Array.fromBase64)return Uint8Array.fromBase64("string"==typeof e?e:s.decode(e),{alphabet:"base64url"});let t=e;t instanceof Uint8Array&&(t=s.decode(t)),t=t.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return h(t)}catch{throw new TypeError("The input to be decoded is not correctly encoded.")}}function f(e){let t=e;return"string"==typeof t&&(t=i.encode(t)),Uint8Array.prototype.toBase64?t.toBase64({alphabet:"base64url",omitPadding:!0}):u(t).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}class m extends Error{static code="ERR_JOSE_GENERIC";code="ERR_JOSE_GENERIC";constructor(e,t){super(e,t),this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}}class w extends m{static code="ERR_JWT_CLAIM_VALIDATION_FAILED";code="ERR_JWT_CLAIM_VALIDATION_FAILED";claim;reason;payload;constructor(e,t,r="unspecified",n="unspecified"){super(e,{cause:{claim:r,reason:n,payload:t}}),this.claim=r,this.reason=n,this.payload=t}}class g extends m{static code="ERR_JWT_EXPIRED";code="ERR_JWT_EXPIRED";claim;reason;payload;constructor(e,t,r="unspecified",n="unspecified"){super(e,{cause:{claim:r,reason:n,payload:t}}),this.claim=r,this.reason=n,this.payload=t}}class v extends m{static code="ERR_JOSE_ALG_NOT_ALLOWED";code="ERR_JOSE_ALG_NOT_ALLOWED"}class b extends m{static code="ERR_JOSE_NOT_SUPPORTED";code="ERR_JOSE_NOT_SUPPORTED"}class E extends m{static code="ERR_JWE_DECRYPTION_FAILED";code="ERR_JWE_DECRYPTION_FAILED";constructor(e="decryption operation failed",t){super(e,t)}}class S extends m{static code="ERR_JWE_INVALID";code="ERR_JWE_INVALID"}class A extends m{static code="ERR_JWS_INVALID";code="ERR_JWS_INVALID"}class C extends m{static code="ERR_JWT_INVALID";code="ERR_JWT_INVALID"}class P extends m{static code="ERR_JWK_INVALID";code="ERR_JWK_INVALID"}class T extends m{static code="ERR_JWKS_INVALID";code="ERR_JWKS_INVALID"}class H extends m{static code="ERR_JWKS_NO_MATCHING_KEY";code="ERR_JWKS_NO_MATCHING_KEY";constructor(e="no applicable key found in the JSON Web Key Set",t){super(e,t)}}class O extends m{[Symbol.asyncIterator];static code="ERR_JWKS_MULTIPLE_MATCHING_KEYS";code="ERR_JWKS_MULTIPLE_MATCHING_KEYS";constructor(e="multiple matching keys found in the JSON Web Key Set",t){super(e,t)}}class k extends m{static code="ERR_JWKS_TIMEOUT";code="ERR_JWKS_TIMEOUT";constructor(e="request timed out",t){super(e,t)}}class M extends m{static code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";constructor(e="signature verification failed",t){super(e,t)}}function K(e){switch(e){case"A128GCM":case"A128GCMKW":case"A192GCM":case"A192GCMKW":case"A256GCM":case"A256GCMKW":return 96;case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return 128;default:throw new b(`Unsupported JWE Algorithm: ${e}`)}}const D=(e,t)=>{if(t.length<<3!==K(e))throw new S("Invalid Initialization Vector length")},R=(e,t)=>{const r=e.byteLength<<3;if(r!==t)throw new S(`Invalid Content Encryption Key length. Expected ${t} bits, got ${r} bits`)};function I(e,t="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${t} must be ${e}`)}function F(e,t){return e.name===t}function U(e){return parseInt(e.name.slice(4),10)}function W(e,t){if(t&&!e.usages.includes(t))throw new TypeError(`CryptoKey does not support this operation, its usages must include ${t}.`)}function _(e,t,r){switch(t){case"A128GCM":case"A192GCM":case"A256GCM":{if(!F(e.algorithm,"AES-GCM"))throw I("AES-GCM");const r=parseInt(t.slice(1,4),10);if(e.algorithm.length!==r)throw I(r,"algorithm.length");break}case"A128KW":case"A192KW":case"A256KW":{if(!F(e.algorithm,"AES-KW"))throw I("AES-KW");const r=parseInt(t.slice(1,4),10);if(e.algorithm.length!==r)throw I(r,"algorithm.length");break}case"ECDH":switch(e.algorithm.name){case"ECDH":case"X25519":break;default:throw I("ECDH or X25519")}break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":if(!F(e.algorithm,"PBKDF2"))throw I("PBKDF2");break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":{if(!F(e.algorithm,"RSA-OAEP"))throw I("RSA-OAEP");const r=parseInt(t.slice(9),10)||1;if(U(e.algorithm.hash)!==r)throw I(`SHA-${r}`,"algorithm.hash");break}default:throw new TypeError("CryptoKey does not support this operation")}W(e,r)}function x(e,t,...r){if((r=r.filter(Boolean)).length>2){const t=r.pop();e+=`one of type ${r.join(", ")}, or ${t}.`}else 2===r.length?e+=`one of type ${r[0]} or ${r[1]}.`:e+=`of type ${r[0]}.`;return null==t?e+=` Received ${t}`:"function"==typeof t&&t.name?e+=` Received function ${t.name}`:"object"==typeof t&&null!=t&&t.constructor?.name&&(e+=` Received an instance of ${t.constructor.name}`),e}const j=(e,...t)=>x("Key must be ",e,...t);function N(e,t,...r){return x(`Key for the ${e} algorithm must be `,t,...r)}function J(e){if(!V(e))throw new Error("CryptoKey instance expected")}function V(e){return"CryptoKey"===e?.[Symbol.toStringTag]}function $(e){return"KeyObject"===e?.[Symbol.toStringTag]}const B=e=>V(e)||$(e);const L=async(e,t,r,n,a,i)=>{if(!(V(t)||t instanceof Uint8Array))throw new TypeError(j(t,"CryptoKey","KeyObject","Uint8Array","JSON Web Key"));if(!n)throw new S("JWE Initialization Vector missing");if(!a)throw new S("JWE Authentication Tag missing");switch(D(e,n),e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return t instanceof Uint8Array&&R(t,parseInt(e.slice(-3),10)),async function(e,t,r,n,a,i){if(!(t instanceof Uint8Array))throw new TypeError(j(t,"Uint8Array"));const s=parseInt(e.slice(1,4),10),o=await crypto.subtle.importKey("raw",t.subarray(s>>3),"AES-CBC",!1,["decrypt"]),d=await crypto.subtle.importKey("raw",t.subarray(0,s>>3),{hash:"SHA-"+(s<<1),name:"HMAC"},!1,["sign"]),p=c(i,n,r,l(i.length<<3)),u=new Uint8Array((await crypto.subtle.sign("HMAC",d,p)).slice(0,s>>3));let h,y;try{h=await async function(e,t){if(!(e instanceof Uint8Array))throw new TypeError("First argument must be a buffer");if(!(t instanceof Uint8Array))throw new TypeError("Second argument must be a buffer");const r={name:"HMAC",hash:"SHA-256"},n=await crypto.subtle.generateKey(r,!1,["sign"]),a=new Uint8Array(await crypto.subtle.sign(r,n,e)),i=new Uint8Array(await crypto.subtle.sign(r,n,t));let s=0,o=-1;for(;++o<32;)s|=a[o]^i[o];return 0===s}(a,u)}catch{}if(!h)throw new E;try{y=new Uint8Array(await crypto.subtle.decrypt({iv:n,name:"AES-CBC"},o,r))}catch{}if(!y)throw new E;return y}(e,t,r,n,a,i);case"A128GCM":case"A192GCM":case"A256GCM":return t instanceof Uint8Array&&R(t,parseInt(e.slice(1,4),10)),async function(e,t,r,n,a,i){let s;t instanceof Uint8Array?s=await crypto.subtle.importKey("raw",t,"AES-GCM",!1,["decrypt"]):(_(t,e,"decrypt"),s=t);try{return new Uint8Array(await crypto.subtle.decrypt({additionalData:i,iv:n,name:"AES-GCM",tagLength:128},s,c(r,a)))}catch{throw new E}}(e,t,r,n,a,i);default:throw new b("Unsupported JWE Content Encryption Algorithm")}},G=(...e)=>{const t=e.filter(Boolean);if(0===t.length||1===t.length)return!0;let r;for(const e of t){const t=Object.keys(e);if(r&&0!==r.size)for(const e of t){if(r.has(e))return!1;r.add(e)}else r=new Set(t)}return!0},z=e=>{if("object"!=typeof(t=e)||null===t||"[object Object]"!==Object.prototype.toString.call(e))return!1;var t;if(null===Object.getPrototypeOf(e))return!0;let r=e;for(;null!==Object.getPrototypeOf(r);)r=Object.getPrototypeOf(r);return Object.getPrototypeOf(e)===r};function Y(e,t){if(e.algorithm.length!==parseInt(t.slice(1,4),10))throw new TypeError(`Invalid key size for alg: ${t}`)}function X(e,t,r){return e instanceof Uint8Array?crypto.subtle.importKey("raw",e,"AES-KW",!0,[r]):(_(e,t,r),e)}async function Z(e,t,r){const n=await X(t,e,"wrapKey");Y(n,e);const a=await crypto.subtle.importKey("raw",r,{hash:"SHA-256",name:"HMAC"},!0,["sign"]);return new Uint8Array(await crypto.subtle.wrapKey("raw",a,n,"AES-KW"))}async function q(e,t,r){const n=await X(t,e,"unwrapKey");Y(n,e);const a=await crypto.subtle.unwrapKey("raw",r,n,"AES-KW",{hash:"SHA-256",name:"HMAC"},!0,["sign"]);return new Uint8Array(await crypto.subtle.exportKey("raw",a))}const Q=async(e,t)=>{const r=`SHA-${e.slice(-3)}`;return new Uint8Array(await crypto.subtle.digest(r,t))};function ee(e){return c(p(e.length),e)}async function te(e,t,r,n,a=new Uint8Array(0),s=new Uint8Array(0)){_(e,"ECDH"),_(t,"ECDH","deriveBits");const o=c(ee(i.encode(r)),ee(a),ee(s),p(n));let d;return d="X25519"===e.algorithm.name?256:Math.ceil(parseInt(e.algorithm.namedCurve.slice(-3),10)/8)<<3,async function(e,t,r){const n=Math.ceil((t>>3)/32),a=new Uint8Array(32*n);for(let t=0;t<n;t++){const n=new Uint8Array(4+e.length+r.length);n.set(p(t+1)),n.set(e,4),n.set(r,4+e.length),a.set(await Q("sha256",n),32*t)}return a.slice(0,t>>3)}(new Uint8Array(await crypto.subtle.deriveBits({name:e.algorithm.name,public:e},t,d)),n,o)}function re(e){switch(e.algorithm.namedCurve){case"P-256":case"P-384":case"P-521":return!0;default:return"X25519"===e.algorithm.name}}async function ne(e,t,r,n){if(!(e instanceof Uint8Array)||e.length<8)throw new S("PBES2 Salt Input must be 8 or more octets");const a=((e,t)=>c(i.encode(e),new Uint8Array([0]),t))(t,e),s=parseInt(t.slice(13,16),10),o={hash:`SHA-${t.slice(8,11)}`,iterations:r,name:"PBKDF2",salt:a},d=await function(e,t){return e instanceof Uint8Array?crypto.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits"]):(_(e,t,"deriveBits"),e)}(n,t);return new Uint8Array(await crypto.subtle.deriveBits(o,d,s))}const ae=(e,t)=>{if(e.startsWith("RS")||e.startsWith("PS")){const{modulusLength:r}=t.algorithm;if("number"!=typeof r||r<2048)throw new TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}},ie=e=>{switch(e){case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":return"RSA-OAEP";default:throw new b(`alg ${e} is not supported either by JOSE or your javascript runtime`)}};function se(e){switch(e){case"A128GCM":return 128;case"A192GCM":return 192;case"A256GCM":case"A128CBC-HS256":return 256;case"A192CBC-HS384":return 384;case"A256CBC-HS512":return 512;default:throw new b(`Unsupported JWE Algorithm: ${e}`)}}const oe=e=>crypto.getRandomValues(new Uint8Array(se(e)>>3)),ce=(e,t)=>`-----BEGIN ${t}-----\n${(e.match(/.{1,64}/g)||[]).join("\n")}\n-----END ${t}-----`,de=async(e,t,r)=>{if($(r)){if(r.type!==e)throw new TypeError(`key is not a ${e} key`);return r.export({format:"pem",type:t})}if(!V(r))throw new TypeError(j(r,"CryptoKey","KeyObject"));if(!r.extractable)throw new TypeError("CryptoKey is not extractable");if(r.type!==e)throw new TypeError(`key is not a ${e} key`);return ce(u(new Uint8Array(await crypto.subtle.exportKey(t,r))),`${e.toUpperCase()} KEY`)},le=e=>de("public","spki",e),pe=e=>de("private","pkcs8",e),ue=(e,t,r=0)=>{0===r&&(t.unshift(t.length),t.unshift(6));const n=e.indexOf(t[0],r);if(-1===n)return!1;const a=e.subarray(n,n+t.length);return a.length===t.length&&(a.every(((e,r)=>e===t[r]))||ue(e,t,n+1))},he=async(e,t,r,n,a)=>{let i,s;const o=new Uint8Array(atob(r.replace(e,"")).split("").map((e=>e.charCodeAt(0)))),c="spki"===t;switch(n){case"PS256":case"PS384":case"PS512":i={name:"RSA-PSS",hash:`SHA-${n.slice(-3)}`},s=c?["verify"]:["sign"];break;case"RS256":case"RS384":case"RS512":i={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${n.slice(-3)}`},s=c?["verify"]:["sign"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":i={name:"RSA-OAEP",hash:`SHA-${parseInt(n.slice(-3),10)||1}`},s=c?["encrypt","wrapKey"]:["decrypt","unwrapKey"];break;case"ES256":i={name:"ECDSA",namedCurve:"P-256"},s=c?["verify"]:["sign"];break;case"ES384":i={name:"ECDSA",namedCurve:"P-384"},s=c?["verify"]:["sign"];break;case"ES512":i={name:"ECDSA",namedCurve:"P-521"},s=c?["verify"]:["sign"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{const e=(e=>{switch(!0){case ue(e,[42,134,72,206,61,3,1,7]):return"P-256";case ue(e,[43,129,4,0,34]):return"P-384";case ue(e,[43,129,4,0,35]):return"P-521";default:return}})(o);i=e?.startsWith("P-")?{name:"ECDH",namedCurve:e}:{name:"X25519"},s=c?[]:["deriveBits"];break}case"Ed25519":case"EdDSA":i={name:"Ed25519"},s=c?["verify"]:["sign"];break;default:throw new b('Invalid or unsupported "alg" (Algorithm) value')}return crypto.subtle.importKey(t,o,i,a?.extractable??!!c,s)},ye=(e,t,r)=>he(/(?:-----(?:BEGIN|END) PRIVATE KEY-----|\s)/g,"pkcs8",e,t,r),fe=(e,t,r)=>he(/(?:-----(?:BEGIN|END) PUBLIC KEY-----|\s)/g,"spki",e,t,r);function me(e){const t=[];let r=0;for(;r<e.length;){const n=we(e.subarray(r));t.push(n),r+=n.byteLength}return t}function we(e){let t=0,r=31&e[0];if(t++,31===r){for(r=0;e[t]>=128;)r=128*r+e[t]-128,t++;r=128*r+e[t]-128,t++}let n=0;if(e[t]<128)n=e[t],t++;else{if(128===n){for(n=0;0!==e[t+n]||0!==e[t+n+1];){if(n>e.byteLength)throw new TypeError("invalid indefinite form length");n++}const r=t+n+2;return{byteLength:r,contents:e.subarray(t,t+n),raw:e.subarray(0,r)}}{const r=127&e[t];t++,n=0;for(let a=0;a<r;a++)n=256*n+e[t],t++}}const a=t+n;return{byteLength:a,contents:e.subarray(t,a),raw:e.subarray(0,a)}}let ge;const ve=(e,t,r)=>{let n;try{n=function(e){try{ge??=globalThis.process?.getBuiltinModule?.("node:crypto")?.createPublicKey}catch{ge=0}if(ge)try{return new ge(e).export({format:"pem",type:"spki"})}catch{}const t=h(e.replace(/(?:-----(?:BEGIN|END) CERTIFICATE-----|\s)/g,""));return ce(function(e){const t=me(me(we(e).contents)[0].contents);return u(t[160===t[0].raw[0]?6:5].raw)}(t),"PUBLIC KEY")}(e)}catch(e){throw new TypeError("Failed to parse the X.509 certificate",{cause:e})}return fe(n,t,r)},be=async e=>{if(!e.alg)throw new TypeError('"alg" argument is required when "jwk.alg" is not present');const{algorithm:t,keyUsages:r}=function(e){let t,r;switch(e.kty){case"RSA":switch(e.alg){case"PS256":case"PS384":case"PS512":t={name:"RSA-PSS",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":t={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":t={name:"RSA-OAEP",hash:`SHA-${parseInt(e.alg.slice(-3),10)||1}`},r=e.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new b('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"EC":switch(e.alg){case"ES256":t={name:"ECDSA",namedCurve:"P-256"},r=e.d?["sign"]:["verify"];break;case"ES384":t={name:"ECDSA",namedCurve:"P-384"},r=e.d?["sign"]:["verify"];break;case"ES512":t={name:"ECDSA",namedCurve:"P-521"},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:"ECDH",namedCurve:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new b('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"OKP":switch(e.alg){case"Ed25519":case"EdDSA":t={name:"Ed25519"},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new b('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;default:throw new b('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:t,keyUsages:r}}(e),n={...e};return delete n.alg,delete n.use,crypto.subtle.importKey("jwk",n,t,e.ext??!e.d,e.key_ops??r)};async function Ee(e,t,r){if("string"!=typeof e||0!==e.indexOf("-----BEGIN PUBLIC KEY-----"))throw new TypeError('"spki" must be SPKI formatted string');return fe(e,t,r)}async function Se(e,t,r){if("string"!=typeof e||0!==e.indexOf("-----BEGIN CERTIFICATE-----"))throw new TypeError('"x509" must be X.509 formatted string');return ve(e,t,r)}async function Ae(e,t,r){if("string"!=typeof e||0!==e.indexOf("-----BEGIN PRIVATE KEY-----"))throw new TypeError('"pkcs8" must be PKCS#8 formatted string');return ye(e,t,r)}async function Ce(e,t,r){if(!z(e))throw new TypeError("JWK must be an object");let n;switch(t??=e.alg,n??=r?.extractable??e.ext,e.kty){case"oct":if("string"!=typeof e.k||!e.k)throw new TypeError('missing "k" (Key Value) Parameter value');return y(e.k);case"RSA":if("oth"in e&&void 0!==e.oth)throw new b('RSA JWK "oth" (Other Primes Info) Parameter value is not supported');case"EC":case"OKP":return be({...e,alg:t,ext:n});default:throw new b('Unsupported "kty" (Key Type) Parameter value')}}const Pe=async(e,t,r,n,a)=>{if(!(V(r)||r instanceof Uint8Array))throw new TypeError(j(r,"CryptoKey","KeyObject","Uint8Array","JSON Web Key"));var i;switch(n?D(e,n):(i=e,n=crypto.getRandomValues(new Uint8Array(K(i)>>3))),e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return r instanceof Uint8Array&&R(r,parseInt(e.slice(-3),10)),async function(e,t,r,n,a){if(!(r instanceof Uint8Array))throw new TypeError(j(r,"Uint8Array"));const i=parseInt(e.slice(1,4),10),s=await crypto.subtle.importKey("raw",r.subarray(i>>3),"AES-CBC",!1,["encrypt"]),o=await crypto.subtle.importKey("raw",r.subarray(0,i>>3),{hash:"SHA-"+(i<<1),name:"HMAC"},!1,["sign"]),d=new Uint8Array(await crypto.subtle.encrypt({iv:n,name:"AES-CBC"},s,t)),p=c(a,n,d,l(a.length<<3));return{ciphertext:d,tag:new Uint8Array((await crypto.subtle.sign("HMAC",o,p)).slice(0,i>>3)),iv:n}}(e,t,r,n,a);case"A128GCM":case"A192GCM":case"A256GCM":return r instanceof Uint8Array&&R(r,parseInt(e.slice(1,4),10)),async function(e,t,r,n,a){let i;r instanceof Uint8Array?i=await crypto.subtle.importKey("raw",r,"AES-GCM",!1,["encrypt"]):(_(r,e,"encrypt"),i=r);const s=new Uint8Array(await crypto.subtle.encrypt({additionalData:a,iv:n,name:"AES-GCM",tagLength:128},i,t)),o=s.slice(-16);return{ciphertext:s.slice(0,-16),tag:o,iv:n}}(e,t,r,n,a);default:throw new b("Unsupported JWE Content Encryption Algorithm")}},Te=async(e,t,r,n,a)=>{switch(e){case"dir":if(void 0!==r)throw new S("Encountered unexpected JWE Encrypted Key");return t;case"ECDH-ES":if(void 0!==r)throw new S("Encountered unexpected JWE Encrypted Key");case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{if(!z(n.epk))throw new S('JOSE Header "epk" (Ephemeral Public Key) missing or invalid');if(J(t),!re(t))throw new b("ECDH with the provided key is not allowed or not supported by your javascript runtime");const a=await Ce(n.epk,e);let i,s;if(J(a),void 0!==n.apu){if("string"!=typeof n.apu)throw new S('JOSE Header "apu" (Agreement PartyUInfo) invalid');try{i=y(n.apu)}catch{throw new S("Failed to base64url decode the apu")}}if(void 0!==n.apv){if("string"!=typeof n.apv)throw new S('JOSE Header "apv" (Agreement PartyVInfo) invalid');try{s=y(n.apv)}catch{throw new S("Failed to base64url decode the apv")}}const o=await te(a,t,"ECDH-ES"===e?n.enc:e,"ECDH-ES"===e?se(n.enc):parseInt(e.slice(-5,-2),10),i,s);if("ECDH-ES"===e)return o;if(void 0===r)throw new S("JWE Encrypted Key missing");return q(e.slice(-6),o,r)}case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":if(void 0===r)throw new S("JWE Encrypted Key missing");return J(t),async function(e,t,r){return _(t,e,"decrypt"),ae(e,t),new Uint8Array(await crypto.subtle.decrypt(ie(e),t,r))}(e,t,r);case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":{if(void 0===r)throw new S("JWE Encrypted Key missing");if("number"!=typeof n.p2c)throw new S('JOSE Header "p2c" (PBES2 Count) missing or invalid');const i=a?.maxPBES2Count||1e4;if(n.p2c>i)throw new S('JOSE Header "p2c" (PBES2 Count) out is of acceptable bounds');if("string"!=typeof n.p2s)throw new S('JOSE Header "p2s" (PBES2 Salt) missing or invalid');let s;try{s=y(n.p2s)}catch{throw new S("Failed to base64url decode the p2s")}return async function(e,t,r,n,a){const i=await ne(a,e,n,t);return q(e.slice(-6),i,r)}(e,t,r,n.p2c,s)}case"A128KW":case"A192KW":case"A256KW":if(void 0===r)throw new S("JWE Encrypted Key missing");return q(e,t,r);case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":{if(void 0===r)throw new S("JWE Encrypted Key missing");if("string"!=typeof n.iv)throw new S('JOSE Header "iv" (Initialization Vector) missing or invalid');if("string"!=typeof n.tag)throw new S('JOSE Header "tag" (Authentication Tag) missing or invalid');let a,i;try{a=y(n.iv)}catch{throw new S("Failed to base64url decode the iv")}try{i=y(n.tag)}catch{throw new S("Failed to base64url decode the tag")}return async function(e,t,r,n,a){const i=e.slice(0,7);return L(i,t,r,n,a,new Uint8Array(0))}(e,t,r,a,i)}default:throw new b('Invalid or unsupported "alg" (JWE Algorithm) header value')}},He=(e,t,r,n,a)=>{if(void 0!==a.crit&&void 0===n?.crit)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!n||void 0===n.crit)return new Set;if(!Array.isArray(n.crit)||0===n.crit.length||n.crit.some((e=>"string"!=typeof e||0===e.length)))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let i;i=void 0!==r?new Map([...Object.entries(r),...t.entries()]):t;for(const t of n.crit){if(!i.has(t))throw new b(`Extension Header Parameter "${t}" is not recognized`);if(void 0===a[t])throw new e(`Extension Header Parameter "${t}" is missing`);if(i.get(t)&&void 0===n[t])throw new e(`Extension Header Parameter "${t}" MUST be integrity protected`)}return new Set(n.crit)},Oe=(e,t)=>{if(void 0!==t&&(!Array.isArray(t)||t.some((e=>"string"!=typeof e))))throw new TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)};function ke(e){return z(e)&&"string"==typeof e.kty}let Me;const Ke=async(e,t,r,n=!1)=>{Me||=new WeakMap;let a=Me.get(e);if(a?.[r])return a[r];const i=await be({...t,alg:r});return n&&Object.freeze(e),a?a[r]=i:Me.set(e,{[r]:i}),i},De=async(e,t)=>{if(e instanceof Uint8Array)return e;if(V(e))return e;if($(e)){if("secret"===e.type)return e.export();if("toCryptoKey"in e&&"function"==typeof e.toCryptoKey)try{return((e,t)=>{Me||=new WeakMap;let r=Me.get(e);if(r?.[t])return r[t];const n="public"===e.type,a=!!n;let i;if("x25519"===e.asymmetricKeyType){switch(t){case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":break;default:throw new TypeError("given KeyObject instance cannot be used for this algorithm")}i=e.toCryptoKey(e.asymmetricKeyType,a,n?[]:["deriveBits"])}if("ed25519"===e.asymmetricKeyType){if("EdDSA"!==t&&"Ed25519"!==t)throw new TypeError("given KeyObject instance cannot be used for this algorithm");i=e.toCryptoKey(e.asymmetricKeyType,a,[n?"verify":"sign"])}if("rsa"===e.asymmetricKeyType){let r;switch(t){case"RSA-OAEP":r="SHA-1";break;case"RS256":case"PS256":case"RSA-OAEP-256":r="SHA-256";break;case"RS384":case"PS384":case"RSA-OAEP-384":r="SHA-384";break;case"RS512":case"PS512":case"RSA-OAEP-512":r="SHA-512";break;default:throw new TypeError("given KeyObject instance cannot be used for this algorithm")}if(t.startsWith("RSA-OAEP"))return e.toCryptoKey({name:"RSA-OAEP",hash:r},a,n?["encrypt"]:["decrypt"]);i=e.toCryptoKey({name:t.startsWith("PS")?"RSA-PSS":"RSASSA-PKCS1-v1_5",hash:r},a,[n?"verify":"sign"])}if("ec"===e.asymmetricKeyType){const r=new Map([["prime256v1","P-256"],["secp384r1","P-384"],["secp521r1","P-521"]]).get(e.asymmetricKeyDetails?.namedCurve);if(!r)throw new TypeError("given KeyObject instance cannot be used for this algorithm");"ES256"===t&&"P-256"===r&&(i=e.toCryptoKey({name:"ECDSA",namedCurve:r},a,[n?"verify":"sign"])),"ES384"===t&&"P-384"===r&&(i=e.toCryptoKey({name:"ECDSA",namedCurve:r},a,[n?"verify":"sign"])),"ES512"===t&&"P-521"===r&&(i=e.toCryptoKey({name:"ECDSA",namedCurve:r},a,[n?"verify":"sign"])),t.startsWith("ECDH-ES")&&(i=e.toCryptoKey({name:"ECDH",namedCurve:r},a,n?[]:["deriveBits"]))}if(!i)throw new TypeError("given KeyObject instance cannot be used for this algorithm");return r?r[t]=i:Me.set(e,{[t]:i}),i})(e,t)}catch(e){if(e instanceof TypeError)throw e}let r=e.export({format:"jwk"});return Ke(e,r,t)}if(ke(e))return e.k?y(e.k):Ke(e,e,t,!0);throw new Error("unreachable")},Re=e=>e?.[Symbol.toStringTag],Ie=(e,t,r)=>{if(void 0!==t.use){let e;switch(r){case"sign":case"verify":e="sig";break;case"encrypt":case"decrypt":e="enc"}if(t.use!==e)throw new TypeError(`Invalid key for this operation, its "use" must be "${e}" when present`)}if(void 0!==t.alg&&t.alg!==e)throw new TypeError(`Invalid key for this operation, its "alg" must be "${e}" when present`);if(Array.isArray(t.key_ops)){let n;switch(!0){case"sign"===r||"verify"===r:case"dir"===e:case e.includes("CBC-HS"):n=r;break;case e.startsWith("PBES2"):n="deriveBits";break;case/^A\d{3}(?:GCM)?(?:KW)?$/.test(e):n=!e.includes("GCM")&&e.endsWith("KW")?"encrypt"===r?"wrapKey":"unwrapKey":r;break;case"encrypt"===r&&e.startsWith("RSA"):n="wrapKey";break;case"decrypt"===r:n=e.startsWith("RSA")?"unwrapKey":"deriveBits"}if(n&&!1===t.key_ops?.includes?.(n))throw new TypeError(`Invalid key for this operation, its "key_ops" must include "${n}" when present`)}return!0},Fe=(e,t,r)=>{e.startsWith("HS")||"dir"===e||e.startsWith("PBES2")||/^A(?:128|192|256)(?:GCM)?(?:KW)?$/.test(e)||/^A(?:128|192|256)CBC-HS(?:256|384|512)$/.test(e)?((e,t,r)=>{if(!(t instanceof Uint8Array)){if(ke(t)){if(function(e){return"oct"===e.kty&&"string"==typeof e.k}(t)&&Ie(e,t,r))return;throw new TypeError('JSON Web Key for symmetric algorithms must have JWK "kty" (Key Type) equal to "oct" and the JWK "k" (Key Value) present')}if(!B(t))throw new TypeError(N(e,t,"CryptoKey","KeyObject","JSON Web Key","Uint8Array"));if("secret"!==t.type)throw new TypeError(`${Re(t)} instances for symmetric algorithms must be of type "secret"`)}})(e,t,r):((e,t,r)=>{if(ke(t))switch(r){case"decrypt":case"sign":if(function(e){return"oct"!==e.kty&&"string"==typeof e.d}(t)&&Ie(e,t,r))return;throw new TypeError("JSON Web Key for this operation be a private JWK");case"encrypt":case"verify":if(function(e){return"oct"!==e.kty&&void 0===e.d}(t)&&Ie(e,t,r))return;throw new TypeError("JSON Web Key for this operation be a public JWK")}if(!B(t))throw new TypeError(N(e,t,"CryptoKey","KeyObject","JSON Web Key"));if("secret"===t.type)throw new TypeError(`${Re(t)} instances for asymmetric algorithms must not be of type "secret"`);if("public"===t.type)switch(r){case"sign":throw new TypeError(`${Re(t)} instances for asymmetric algorithm signing must be of type "private"`);case"decrypt":throw new TypeError(`${Re(t)} instances for asymmetric algorithm decryption must be of type "private"`)}if("private"===t.type)switch(r){case"verify":throw new TypeError(`${Re(t)} instances for asymmetric algorithm verifying must be of type "public"`);case"encrypt":throw new TypeError(`${Re(t)} instances for asymmetric algorithm encryption must be of type "public"`)}})(e,t,r)};async function Ue(e,t,r){if(!z(e))throw new S("Flattened JWE must be an object");if(void 0===e.protected&&void 0===e.header&&void 0===e.unprotected)throw new S("JOSE Header missing");if(void 0!==e.iv&&"string"!=typeof e.iv)throw new S("JWE Initialization Vector incorrect type");if("string"!=typeof e.ciphertext)throw new S("JWE Ciphertext missing or incorrect type");if(void 0!==e.tag&&"string"!=typeof e.tag)throw new S("JWE Authentication Tag incorrect type");if(void 0!==e.protected&&"string"!=typeof e.protected)throw new S("JWE Protected Header incorrect type");if(void 0!==e.encrypted_key&&"string"!=typeof e.encrypted_key)throw new S("JWE Encrypted Key incorrect type");if(void 0!==e.aad&&"string"!=typeof e.aad)throw new S("JWE AAD incorrect type");if(void 0!==e.header&&!z(e.header))throw new S("JWE Shared Unprotected Header incorrect type");if(void 0!==e.unprotected&&!z(e.unprotected))throw new S("JWE Per-Recipient Unprotected Header incorrect type");let n;if(e.protected)try{const t=y(e.protected);n=JSON.parse(s.decode(t))}catch{throw new S("JWE Protected Header is invalid")}if(!G(n,e.header,e.unprotected))throw new S("JWE Protected, JWE Unprotected Header, and JWE Per-Recipient Unprotected Header Parameter names must be disjoint");const a={...n,...e.header,...e.unprotected};if(He(S,new Map,r?.crit,n,a),void 0!==a.zip)throw new b('JWE "zip" (Compression Algorithm) Header Parameter is not supported.');const{alg:o,enc:d}=a;if("string"!=typeof o||!o)throw new S("missing JWE Algorithm (alg) in JWE Header");if("string"!=typeof d||!d)throw new S("missing JWE Encryption Algorithm (enc) in JWE Header");const l=r&&Oe("keyManagementAlgorithms",r.keyManagementAlgorithms),p=r&&Oe("contentEncryptionAlgorithms",r.contentEncryptionAlgorithms);if(l&&!l.has(o)||!l&&o.startsWith("PBES2"))throw new v('"alg" (Algorithm) Header Parameter value not allowed');if(p&&!p.has(d))throw new v('"enc" (Encryption Algorithm) Header Parameter value not allowed');let u;if(void 0!==e.encrypted_key)try{u=y(e.encrypted_key)}catch{throw new S("Failed to base64url decode the encrypted_key")}let h=!1;"function"==typeof t&&(t=await t(n,e),h=!0),Fe("dir"===o?d:o,t,"decrypt");const f=await De(t,o);let m,w,g;try{m=await Te(o,f,u,a,r)}catch(e){if(e instanceof TypeError||e instanceof S||e instanceof b)throw e;m=oe(d)}if(void 0!==e.iv)try{w=y(e.iv)}catch{throw new S("Failed to base64url decode the iv")}if(void 0!==e.tag)try{g=y(e.tag)}catch{throw new S("Failed to base64url decode the tag")}const E=i.encode(e.protected??"");let A,C;A=void 0!==e.aad?c(E,i.encode("."),i.encode(e.aad)):E;try{C=y(e.ciphertext)}catch{throw new S("Failed to base64url decode the ciphertext")}const P={plaintext:await L(d,m,C,w,g,A)};if(void 0!==e.protected&&(P.protectedHeader=n),void 0!==e.aad)try{P.additionalAuthenticatedData=y(e.aad)}catch{throw new S("Failed to base64url decode the aad")}return void 0!==e.unprotected&&(P.sharedUnprotectedHeader=e.unprotected),void 0!==e.header&&(P.unprotectedHeader=e.header),h?{...P,key:f}:P}async function We(e,t,r){if(e instanceof Uint8Array&&(e=s.decode(e)),"string"!=typeof e)throw new S("Compact JWE must be a string or Uint8Array");const{0:n,1:a,2:i,3:o,4:c,length:d}=e.split(".");if(5!==d)throw new S("Invalid Compact JWE");const l=await Ue({ciphertext:o,iv:i||void 0,protected:n,tag:c||void 0,encrypted_key:a||void 0},t,r),p={plaintext:l.plaintext,protectedHeader:l.protectedHeader};return"function"==typeof t?{...p,key:l.key}:p}async function _e(e,t,r){if(!z(e))throw new S("General JWE must be an object");if(!Array.isArray(e.recipients)||!e.recipients.every(z))throw new S("JWE Recipients missing or incorrect type");if(!e.recipients.length)throw new S("JWE Recipients has no members");for(const n of e.recipients)try{return await Ue({aad:e.aad,ciphertext:e.ciphertext,encrypted_key:n.encrypted_key,header:n.header,iv:e.iv,protected:e.protected,tag:e.tag,unprotected:e.unprotected},t,r)}catch{}throw new E}const xe=Symbol();async function je(e){return le(e)}async function Ne(e){return pe(e)}async function Je(e){return async function(e){if($(e)){if("secret"!==e.type)return e.export({format:"jwk"});e=e.export()}if(e instanceof Uint8Array)return{kty:"oct",k:f(e)};if(!V(e))throw new TypeError(j(e,"CryptoKey","KeyObject","Uint8Array"));if(!e.extractable)throw new TypeError("non-extractable CryptoKey cannot be exported as a JWK");const{ext:t,key_ops:r,alg:n,use:a,...i}=await crypto.subtle.exportKey("jwk",e);return i}(e)}const Ve=async(e,t,r,n,a={})=>{let i,s,o;switch(e){case"dir":o=r;break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{if(J(r),!re(r))throw new b("ECDH with the provided key is not allowed or not supported by your javascript runtime");const{apu:c,apv:d}=a;let l;l=a.epk?await De(a.epk,e):(await crypto.subtle.generateKey(r.algorithm,!0,["deriveBits"])).privateKey;const{x:p,y:u,crv:h,kty:y}=await Je(l),m=await te(r,l,"ECDH-ES"===e?t:e,"ECDH-ES"===e?se(t):parseInt(e.slice(-5,-2),10),c,d);if(s={epk:{x:p,crv:h,kty:y}},"EC"===y&&(s.epk.y=u),c&&(s.apu=f(c)),d&&(s.apv=f(d)),"ECDH-ES"===e){o=m;break}o=n||oe(t);const w=e.slice(-6);i=await Z(w,m,o);break}case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":o=n||oe(t),J(r),i=await async function(e,t,r){return _(t,e,"encrypt"),ae(e,t),new Uint8Array(await crypto.subtle.encrypt(ie(e),t,r))}(e,r,o);break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":{o=n||oe(t);const{p2c:c,p2s:d}=a;({encryptedKey:i,...s}=await async function(e,t,r,n=2048,a=crypto.getRandomValues(new Uint8Array(16))){const i=await ne(a,e,n,t);return{encryptedKey:await Z(e.slice(-6),i,r),p2c:n,p2s:f(a)}}(e,r,o,c,d));break}case"A128KW":case"A192KW":case"A256KW":o=n||oe(t),i=await Z(e,r,o);break;case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":{o=n||oe(t);const{iv:c}=a;({encryptedKey:i,...s}=await async function(e,t,r,n){const a=e.slice(0,7),i=await Pe(a,r,t,n,new Uint8Array(0));return{encryptedKey:i.ciphertext,iv:f(i.iv),tag:f(i.tag)}}(e,r,o,c));break}default:throw new b('Invalid or unsupported "alg" (JWE Algorithm) header value')}return{cek:o,encryptedKey:i,parameters:s}};class $e{#e;#t;#r;#n;#a;#i;#s;#o;constructor(e){if(!(e instanceof Uint8Array))throw new TypeError("plaintext must be an instance of Uint8Array");this.#e=e}setKeyManagementParameters(e){if(this.#o)throw new TypeError("setKeyManagementParameters can only be called once");return this.#o=e,this}setProtectedHeader(e){if(this.#t)throw new TypeError("setProtectedHeader can only be called once");return this.#t=e,this}setSharedUnprotectedHeader(e){if(this.#r)throw new TypeError("setSharedUnprotectedHeader can only be called once");return this.#r=e,this}setUnprotectedHeader(e){if(this.#n)throw new TypeError("setUnprotectedHeader can only be called once");return this.#n=e,this}setAdditionalAuthenticatedData(e){return this.#a=e,this}setContentEncryptionKey(e){if(this.#i)throw new TypeError("setContentEncryptionKey can only be called once");return this.#i=e,this}setInitializationVector(e){if(this.#s)throw new TypeError("setInitializationVector can only be called once");return this.#s=e,this}async encrypt(e,t){if(!this.#t&&!this.#n&&!this.#r)throw new S("either setProtectedHeader, setUnprotectedHeader, or sharedUnprotectedHeader must be called before #encrypt()");if(!G(this.#t,this.#n,this.#r))throw new S("JWE Protected, JWE Shared Unprotected and JWE Per-Recipient Header Parameter names must be disjoint");const r={...this.#t,...this.#n,...this.#r};if(He(S,new Map,t?.crit,this.#t,r),void 0!==r.zip)throw new b('JWE "zip" (Compression Algorithm) Header Parameter is not supported.');const{alg:n,enc:a}=r;if("string"!=typeof n||!n)throw new S('JWE "alg" (Algorithm) Header Parameter missing or invalid');if("string"!=typeof a||!a)throw new S('JWE "enc" (Encryption Algorithm) Header Parameter missing or invalid');let o,d,l,p,u;if(this.#i&&("dir"===n||"ECDH-ES"===n))throw new TypeError(`setContentEncryptionKey cannot be called with JWE "alg" (Algorithm) Header ${n}`);Fe("dir"===n?a:n,e,"encrypt");{let r;const i=await De(e,n);({cek:d,encryptedKey:o,parameters:r}=await Ve(n,a,i,this.#i,this.#o)),r&&(t&&xe in t?this.#n?this.#n={...this.#n,...r}:this.setUnprotectedHeader(r):this.#t?this.#t={...this.#t,...r}:this.setProtectedHeader(r))}p=this.#t?i.encode(f(JSON.stringify(this.#t))):i.encode(""),this.#a?(u=f(this.#a),l=c(p,i.encode("."),i.encode(u))):l=p;const{ciphertext:h,tag:y,iv:m}=await Pe(a,this.#e,d,this.#s,l),w={ciphertext:f(h)};return m&&(w.iv=f(m)),y&&(w.tag=f(y)),o&&(w.encrypted_key=f(o)),u&&(w.aad=u),this.#t&&(w.protected=s.decode(p)),this.#r&&(w.unprotected=this.#r),this.#n&&(w.header=this.#n),w}}class Be{#c;unprotectedHeader;key;options;constructor(e,t,r){this.#c=e,this.key=t,this.options=r}setUnprotectedHeader(e){if(this.unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this.unprotectedHeader=e,this}addRecipient(...e){return this.#c.addRecipient(...e)}encrypt(...e){return this.#c.encrypt(...e)}done(){return this.#c}}class Le{#e;#d=[];#t;#n;#a;constructor(e){this.#e=e}addRecipient(e,t){const r=new Be(this,e,{crit:t?.crit});return this.#d.push(r),r}setProtectedHeader(e){if(this.#t)throw new TypeError("setProtectedHeader can only be called once");return this.#t=e,this}setSharedUnprotectedHeader(e){if(this.#n)throw new TypeError("setSharedUnprotectedHeader can only be called once");return this.#n=e,this}setAdditionalAuthenticatedData(e){return this.#a=e,this}async encrypt(){if(!this.#d.length)throw new S("at least one recipient must be added");if(1===this.#d.length){const[e]=this.#d,t=await new $e(this.#e).setAdditionalAuthenticatedData(this.#a).setProtectedHeader(this.#t).setSharedUnprotectedHeader(this.#n).setUnprotectedHeader(e.unprotectedHeader).encrypt(e.key,{...e.options}),r={ciphertext:t.ciphertext,iv:t.iv,recipients:[{}],tag:t.tag};return t.aad&&(r.aad=t.aad),t.protected&&(r.protected=t.protected),t.unprotected&&(r.unprotected=t.unprotected),t.encrypted_key&&(r.recipients[0].encrypted_key=t.encrypted_key),t.header&&(r.recipients[0].header=t.header),r}let e;for(let t=0;t<this.#d.length;t++){const r=this.#d[t];if(!G(this.#t,this.#n,r.unprotectedHeader))throw new S("JWE Protected, JWE Shared Unprotected and JWE Per-Recipient Header Parameter names must be disjoint");const n={...this.#t,...this.#n,...r.unprotectedHeader},{alg:a}=n;if("string"!=typeof a||!a)throw new S('JWE "alg" (Algorithm) Header Parameter missing or invalid');if("dir"===a||"ECDH-ES"===a)throw new S('"dir" and "ECDH-ES" alg may only be used with a single recipient');if("string"!=typeof n.enc||!n.enc)throw new S('JWE "enc" (Encryption Algorithm) Header Parameter missing or invalid');if(e){if(e!==n.enc)throw new S('JWE "enc" (Encryption Algorithm) Header Parameter must be the same for all recipients')}else e=n.enc;if(He(S,new Map,r.options.crit,this.#t,n),void 0!==n.zip)throw new b('JWE "zip" (Compression Algorithm) Header Parameter is not supported.')}const t=oe(e),r={ciphertext:"",iv:"",recipients:[],tag:""};for(let n=0;n<this.#d.length;n++){const a=this.#d[n],i={};r.recipients.push(i);const s={...this.#t,...this.#n,...a.unprotectedHeader}.alg.startsWith("PBES2")?2048+n:void 0;if(0===n){const e=await new $e(this.#e).setAdditionalAuthenticatedData(this.#a).setContentEncryptionKey(t).setProtectedHeader(this.#t).setSharedUnprotectedHeader(this.#n).setUnprotectedHeader(a.unprotectedHeader).setKeyManagementParameters({p2c:s}).encrypt(a.key,{...a.options,[xe]:!0});r.ciphertext=e.ciphertext,r.iv=e.iv,r.tag=e.tag,e.aad&&(r.aad=e.aad),e.protected&&(r.protected=e.protected),e.unprotected&&(r.unprotected=e.unprotected),i.encrypted_key=e.encrypted_key,e.header&&(i.header=e.header);continue}const o=a.unprotectedHeader?.alg||this.#t?.alg||this.#n?.alg;Fe("dir"===o?e:o,a.key,"encrypt");const c=await De(a.key,o),{encryptedKey:d,parameters:l}=await Ve(o,e,c,t,{p2c:s});i.encrypted_key=f(d),(a.unprotectedHeader||l)&&(i.header={...a.unprotectedHeader,...l})}return r}}const Ge=(e,t)=>{const r=`SHA-${e.slice(-3)}`;switch(e){case"HS256":case"HS384":case"HS512":return{hash:r,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:r,name:"RSA-PSS",saltLength:parseInt(e.slice(-3),10)>>3};case"RS256":case"RS384":case"RS512":return{hash:r,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:r,name:"ECDSA",namedCurve:t.namedCurve};case"Ed25519":case"EdDSA":return{name:"Ed25519"};default:throw new b(`alg ${e} is not supported either by JOSE or your javascript runtime`)}},ze=async(e,t,r)=>{if(t instanceof Uint8Array){if(!e.startsWith("HS"))throw new TypeError(j(t,"CryptoKey","KeyObject","JSON Web Key"));return crypto.subtle.importKey("raw",t,{hash:`SHA-${e.slice(-3)}`,name:"HMAC"},!1,[r])}return function(e,t,r){switch(t){case"HS256":case"HS384":case"HS512":{if(!F(e.algorithm,"HMAC"))throw I("HMAC");const r=parseInt(t.slice(2),10);if(U(e.algorithm.hash)!==r)throw I(`SHA-${r}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!F(e.algorithm,"RSASSA-PKCS1-v1_5"))throw I("RSASSA-PKCS1-v1_5");const r=parseInt(t.slice(2),10);if(U(e.algorithm.hash)!==r)throw I(`SHA-${r}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!F(e.algorithm,"RSA-PSS"))throw I("RSA-PSS");const r=parseInt(t.slice(2),10);if(U(e.algorithm.hash)!==r)throw I(`SHA-${r}`,"algorithm.hash");break}case"Ed25519":case"EdDSA":if(!F(e.algorithm,"Ed25519"))throw I("Ed25519");break;case"ES256":case"ES384":case"ES512":{if(!F(e.algorithm,"ECDSA"))throw I("ECDSA");const r=function(e){switch(e){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw new Error("unreachable")}}(t);if(e.algorithm.namedCurve!==r)throw I(r,"algorithm.namedCurve");break}default:throw new TypeError("CryptoKey does not support this operation")}W(e,r)}(t,e,r),t},Ye=async(e,t,r,n)=>{const a=await ze(e,t,"verify");ae(e,a);const i=Ge(e,a.algorithm);try{return await crypto.subtle.verify(i,a,r,n)}catch{return!1}};async function Xe(e,t,r){if(!z(e))throw new A("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new A('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new A("JWS Protected Header incorrect type");if(void 0===e.payload)throw new A("JWS Payload missing");if("string"!=typeof e.signature)throw new A("JWS Signature missing or incorrect type");if(void 0!==e.header&&!z(e.header))throw new A("JWS Unprotected Header incorrect type");let n={};if(e.protected)try{const t=y(e.protected);n=JSON.parse(s.decode(t))}catch{throw new A("JWS Protected Header is invalid")}if(!G(n,e.header))throw new A("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const a={...n,...e.header};let o=!0;if(He(A,new Map([["b64",!0]]),r?.crit,n,a).has("b64")&&(o=n.b64,"boolean"!=typeof o))throw new A('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:d}=a;if("string"!=typeof d||!d)throw new A('JWS "alg" (Algorithm) Header Parameter missing or invalid');const l=r&&Oe("algorithms",r.algorithms);if(l&&!l.has(d))throw new v('"alg" (Algorithm) Header Parameter value not allowed');if(o){if("string"!=typeof e.payload)throw new A("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new A("JWS Payload must be a string or an Uint8Array instance");let p=!1;"function"==typeof t&&(t=await t(n,e),p=!0),Fe(d,t,"verify");const u=c(i.encode(e.protected??""),i.encode("."),"string"==typeof e.payload?i.encode(e.payload):e.payload);let h;try{h=y(e.signature)}catch{throw new A("Failed to base64url decode the signature")}const f=await De(t,d);if(!await Ye(d,f,h,u))throw new M;let m;if(o)try{m=y(e.payload)}catch{throw new A("Failed to base64url decode the payload")}else m="string"==typeof e.payload?i.encode(e.payload):e.payload;const w={payload:m};return void 0!==e.protected&&(w.protectedHeader=n),void 0!==e.header&&(w.unprotectedHeader=e.header),p?{...w,key:f}:w}async function Ze(e,t,r){if(e instanceof Uint8Array&&(e=s.decode(e)),"string"!=typeof e)throw new A("Compact JWS must be a string or Uint8Array");const{0:n,1:a,2:i,length:o}=e.split(".");if(3!==o)throw new A("Invalid Compact JWS");const c=await Xe({payload:a,protected:n,signature:i},t,r),d={payload:c.payload,protectedHeader:c.protectedHeader};return"function"==typeof t?{...d,key:c.key}:d}async function qe(e,t,r){if(!z(e))throw new A("General JWS must be an object");if(!Array.isArray(e.signatures)||!e.signatures.every(z))throw new A("JWS Signatures missing or incorrect type");for(const n of e.signatures)try{return await Xe({header:n.header,payload:e.payload,protected:n.protected,signature:n.signature},t,r)}catch{}throw new M}const Qe=e=>Math.floor(e.getTime()/1e3),et=/^(\+|\-)? ?(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)(?: (ago|from now))?$/i,tt=e=>{const t=et.exec(e);if(!t||t[4]&&t[1])throw new TypeError("Invalid time period format");const r=parseFloat(t[2]);let n;switch(t[3].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":n=Math.round(r);break;case"minute":case"minutes":case"min":case"mins":case"m":n=Math.round(60*r);break;case"hour":case"hours":case"hr":case"hrs":case"h":n=Math.round(3600*r);break;case"day":case"days":case"d":n=Math.round(86400*r);break;case"week":case"weeks":case"w":n=Math.round(604800*r);break;default:n=Math.round(31557600*r)}return"-"===t[1]||"ago"===t[4]?-n:n};function rt(e,t){if(!Number.isFinite(t))throw new TypeError(`Invalid ${e} input`);return t}const nt=e=>e.includes("/")?e.toLowerCase():`application/${e.toLowerCase()}`,at=(e,t)=>"string"==typeof e?t.includes(e):!!Array.isArray(e)&&t.some(Set.prototype.has.bind(new Set(e)));function it(e,t,r={}){let n;try{n=JSON.parse(s.decode(t))}catch{}if(!z(n))throw new C("JWT Claims Set must be a top-level JSON object");const{typ:a}=r;if(a&&("string"!=typeof e.typ||nt(e.typ)!==nt(a)))throw new w('unexpected "typ" JWT header value',n,"typ","check_failed");const{requiredClaims:i=[],issuer:o,subject:c,audience:d,maxTokenAge:l}=r,p=[...i];void 0!==l&&p.push("iat"),void 0!==d&&p.push("aud"),void 0!==c&&p.push("sub"),void 0!==o&&p.push("iss");for(const e of new Set(p.reverse()))if(!(e in n))throw new w(`missing required "${e}" claim`,n,e,"missing");if(o&&!(Array.isArray(o)?o:[o]).includes(n.iss))throw new w('unexpected "iss" claim value',n,"iss","check_failed");if(c&&n.sub!==c)throw new w('unexpected "sub" claim value',n,"sub","check_failed");if(d&&!at(n.aud,"string"==typeof d?[d]:d))throw new w('unexpected "aud" claim value',n,"aud","check_failed");let u;switch(typeof r.clockTolerance){case"string":u=tt(r.clockTolerance);break;case"number":u=r.clockTolerance;break;case"undefined":u=0;break;default:throw new TypeError("Invalid clockTolerance option type")}const{currentDate:h}=r,y=Qe(h||new Date);if((void 0!==n.iat||l)&&"number"!=typeof n.iat)throw new w('"iat" claim must be a number',n,"iat","invalid");if(void 0!==n.nbf){if("number"!=typeof n.nbf)throw new w('"nbf" claim must be a number',n,"nbf","invalid");if(n.nbf>y+u)throw new w('"nbf" claim timestamp check failed',n,"nbf","check_failed")}if(void 0!==n.exp){if("number"!=typeof n.exp)throw new w('"exp" claim must be a number',n,"exp","invalid");if(n.exp<=y-u)throw new g('"exp" claim timestamp check failed',n,"exp","check_failed")}if(l){const e=y-n.iat;if(e-u>("number"==typeof l?l:tt(l)))throw new g('"iat" claim timestamp check failed (too far in the past)',n,"iat","check_failed");if(e<0-u)throw new w('"iat" claim timestamp check failed (it should be in the past)',n,"iat","check_failed")}return n}class st{#l;constructor(e){if(!z(e))throw new TypeError("JWT Claims Set MUST be an object");this.#l=structuredClone(e)}data(){return i.encode(JSON.stringify(this.#l))}get iss(){return this.#l.iss}set iss(e){this.#l.iss=e}get sub(){return this.#l.sub}set sub(e){this.#l.sub=e}get aud(){return this.#l.aud}set aud(e){this.#l.aud=e}set jti(e){this.#l.jti=e}set nbf(e){"number"==typeof e?this.#l.nbf=rt("setNotBefore",e):e instanceof Date?this.#l.nbf=rt("setNotBefore",Qe(e)):this.#l.nbf=Qe(new Date)+tt(e)}set exp(e){"number"==typeof e?this.#l.exp=rt("setExpirationTime",e):e instanceof Date?this.#l.exp=rt("setExpirationTime",Qe(e)):this.#l.exp=Qe(new Date)+tt(e)}set iat(e){void 0===e?this.#l.iat=Qe(new Date):e instanceof Date?this.#l.iat=rt("setIssuedAt",Qe(e)):this.#l.iat=rt("setIssuedAt","string"==typeof e?Qe(new Date)+tt(e):e)}}async function ot(e,t,r){const n=await Ze(e,t,r);if(n.protectedHeader.crit?.includes("b64")&&!1===n.protectedHeader.b64)throw new C("JWTs MUST NOT use unencoded payload");const a={payload:it(n.protectedHeader,n.payload,r),protectedHeader:n.protectedHeader};return"function"==typeof t?{...a,key:n.key}:a}async function ct(e,t,r){const n=await We(e,t,r),a=it(n.protectedHeader,n.plaintext,r),{protectedHeader:i}=n;if(void 0!==i.iss&&i.iss!==a.iss)throw new w('replicated "iss" claim header parameter mismatch',a,"iss","mismatch");if(void 0!==i.sub&&i.sub!==a.sub)throw new w('replicated "sub" claim header parameter mismatch',a,"sub","mismatch");if(void 0!==i.aud&&JSON.stringify(i.aud)!==JSON.stringify(a.aud))throw new w('replicated "aud" claim header parameter mismatch',a,"aud","mismatch");const s={payload:a,protectedHeader:i};return"function"==typeof t?{...s,key:n.key}:s}class dt{#p;constructor(e){this.#p=new $e(e)}setContentEncryptionKey(e){return this.#p.setContentEncryptionKey(e),this}setInitializationVector(e){return this.#p.setInitializationVector(e),this}setProtectedHeader(e){return this.#p.setProtectedHeader(e),this}setKeyManagementParameters(e){return this.#p.setKeyManagementParameters(e),this}async encrypt(e,t){const r=await this.#p.encrypt(e,t);return[r.protected,r.encrypted_key,r.iv,r.ciphertext,r.tag].join(".")}}class lt{#l;#t;#n;constructor(e){if(!(e instanceof Uint8Array))throw new TypeError("payload must be an instance of Uint8Array");this.#l=e}setProtectedHeader(e){if(this.#t)throw new TypeError("setProtectedHeader can only be called once");return this.#t=e,this}setUnprotectedHeader(e){if(this.#n)throw new TypeError("setUnprotectedHeader can only be called once");return this.#n=e,this}async sign(e,t){if(!this.#t&&!this.#n)throw new A("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!G(this.#t,this.#n))throw new A("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const r={...this.#t,...this.#n};let n=!0;if(He(A,new Map([["b64",!0]]),t?.crit,this.#t,r).has("b64")&&(n=this.#t.b64,"boolean"!=typeof n))throw new A('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:a}=r;if("string"!=typeof a||!a)throw new A('JWS "alg" (Algorithm) Header Parameter missing or invalid');Fe(a,e,"sign");let o,d=this.#l;n&&(d=i.encode(f(d))),o=this.#t?i.encode(f(JSON.stringify(this.#t))):i.encode("");const l=c(o,i.encode("."),d),p=await De(e,a),u=await(async(e,t,r)=>{const n=await ze(e,t,"sign");ae(e,n);const a=await crypto.subtle.sign(Ge(e,n.algorithm),n,r);return new Uint8Array(a)})(a,p,l),h={signature:f(u),payload:""};return n&&(h.payload=s.decode(d)),this.#n&&(h.header=this.#n),this.#t&&(h.protected=s.decode(o)),h}}class pt{#p;constructor(e){this.#p=new lt(e)}setProtectedHeader(e){return this.#p.setProtectedHeader(e),this}async sign(e,t){const r=await this.#p.sign(e,t);if(void 0===r.payload)throw new TypeError("use the flattened module for creating JWS with b64: false");return`${r.protected}.${r.payload}.${r.signature}`}}class ut{#c;protectedHeader;unprotectedHeader;options;key;constructor(e,t,r){this.#c=e,this.key=t,this.options=r}setProtectedHeader(e){if(this.protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this.protectedHeader=e,this}setUnprotectedHeader(e){if(this.unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this.unprotectedHeader=e,this}addSignature(...e){return this.#c.addSignature(...e)}sign(...e){return this.#c.sign(...e)}done(){return this.#c}}class ht{#l;#u=[];constructor(e){this.#l=e}addSignature(e,t){const r=new ut(this,e,t);return this.#u.push(r),r}async sign(){if(!this.#u.length)throw new A("at least one signature must be added");const e={signatures:[],payload:""};for(let t=0;t<this.#u.length;t++){const r=this.#u[t],n=new lt(this.#l);n.setProtectedHeader(r.protectedHeader),n.setUnprotectedHeader(r.unprotectedHeader);const{payload:a,...i}=await n.sign(r.key,r.options);if(0===t)e.payload=a;else if(e.payload!==a)throw new A("inconsistent use of JWS Unencoded Payload (RFC7797)");e.signatures.push(i)}return e}}class yt{#t;#h;constructor(e={}){this.#h=new st(e)}setIssuer(e){return this.#h.iss=e,this}setSubject(e){return this.#h.sub=e,this}setAudience(e){return this.#h.aud=e,this}setJti(e){return this.#h.jti=e,this}setNotBefore(e){return this.#h.nbf=e,this}setExpirationTime(e){return this.#h.exp=e,this}setIssuedAt(e){return this.#h.iat=e,this}setProtectedHeader(e){return this.#t=e,this}async sign(e,t){const r=new pt(this.#h.data());if(r.setProtectedHeader(this.#t),Array.isArray(this.#t?.crit)&&this.#t.crit.includes("b64")&&!1===this.#t.b64)throw new C("JWTs MUST NOT use unencoded payload");return r.sign(e,t)}}class ft{#i;#s;#o;#t;#y;#f;#m;#h;constructor(e={}){this.#h=new st(e)}setIssuer(e){return this.#h.iss=e,this}setSubject(e){return this.#h.sub=e,this}setAudience(e){return this.#h.aud=e,this}setJti(e){return this.#h.jti=e,this}setNotBefore(e){return this.#h.nbf=e,this}setExpirationTime(e){return this.#h.exp=e,this}setIssuedAt(e){return this.#h.iat=e,this}setProtectedHeader(e){if(this.#t)throw new TypeError("setProtectedHeader can only be called once");return this.#t=e,this}setKeyManagementParameters(e){if(this.#o)throw new TypeError("setKeyManagementParameters can only be called once");return this.#o=e,this}setContentEncryptionKey(e){if(this.#i)throw new TypeError("setContentEncryptionKey can only be called once");return this.#i=e,this}setInitializationVector(e){if(this.#s)throw new TypeError("setInitializationVector can only be called once");return this.#s=e,this}replicateIssuerAsHeader(){return this.#y=!0,this}replicateSubjectAsHeader(){return this.#f=!0,this}replicateAudienceAsHeader(){return this.#m=!0,this}async encrypt(e,t){const r=new dt(this.#h.data());return this.#t&&(this.#y||this.#f||this.#m)&&(this.#t={...this.#t,iss:this.#y?this.#h.iss:void 0,sub:this.#f?this.#h.sub:void 0,aud:this.#m?this.#h.aud:void 0}),r.setProtectedHeader(this.#t),this.#s&&r.setInitializationVector(this.#s),this.#i&&r.setContentEncryptionKey(this.#i),this.#o&&r.setKeyManagementParameters(this.#o),r.encrypt(e,t)}}const mt=(e,t)=>{if("string"!=typeof e||!e)throw new P(`${t} missing or invalid`)};async function wt(e,t){let r,n;if(ke(e))r=e;else{if(!B(e))throw new TypeError(j(e,"CryptoKey","KeyObject","JSON Web Key"));r=await Je(e)}if(t??="sha256","sha256"!==t&&"sha384"!==t&&"sha512"!==t)throw new TypeError('digestAlgorithm must one of "sha256", "sha384", or "sha512"');switch(r.kty){case"EC":mt(r.crv,'"crv" (Curve) Parameter'),mt(r.x,'"x" (X Coordinate) Parameter'),mt(r.y,'"y" (Y Coordinate) Parameter'),n={crv:r.crv,kty:r.kty,x:r.x,y:r.y};break;case"OKP":mt(r.crv,'"crv" (Subtype of Key Pair) Parameter'),mt(r.x,'"x" (Public Key) Parameter'),n={crv:r.crv,kty:r.kty,x:r.x};break;case"RSA":mt(r.e,'"e" (Exponent) Parameter'),mt(r.n,'"n" (Modulus) Parameter'),n={e:r.e,kty:r.kty,n:r.n};break;case"oct":mt(r.k,'"k" (Key Value) Parameter'),n={k:r.k,kty:r.kty};break;default:throw new b('"kty" (Key Type) Parameter missing or unsupported')}const a=i.encode(JSON.stringify(n));return f(await Q(t,a))}async function gt(e,t){t??="sha256";const r=await wt(e,t);return`urn:ietf:params:oauth:jwk-thumbprint:sha-${t.slice(-3)}:${r}`}async function vt(e,t){const r={...e,...t?.header};if(!z(r.jwk))throw new A('"jwk" (JSON Web Key) Header Parameter must be a JSON object');const n=await Ce({...r.jwk,ext:!0},r.alg);if(n instanceof Uint8Array||"public"!==n.type)throw new A('"jwk" (JSON Web Key) Header Parameter must be a public key');return n}function bt(e){return z(e)}class Et{#w;#g=new WeakMap;constructor(e){if(!function(e){return e&&"object"==typeof e&&Array.isArray(e.keys)&&e.keys.every(bt)}(e))throw new T("JSON Web Key Set malformed");this.#w=structuredClone(e)}jwks(){return this.#w}async getKey(e,t){const{alg:r,kid:n}={...e,...t?.header},a=function(e){switch("string"==typeof e&&e.slice(0,2)){case"RS":case"PS":return"RSA";case"ES":return"EC";case"Ed":return"OKP";default:throw new b('Unsupported "alg" value for a JSON Web Key Set')}}(r),i=this.#w.keys.filter((e=>{let t=a===e.kty;if(t&&"string"==typeof n&&(t=n===e.kid),t&&"string"==typeof e.alg&&(t=r===e.alg),t&&"string"==typeof e.use&&(t="sig"===e.use),t&&Array.isArray(e.key_ops)&&(t=e.key_ops.includes("verify")),t)switch(r){case"ES256":t="P-256"===e.crv;break;case"ES384":t="P-384"===e.crv;break;case"ES512":t="P-521"===e.crv;break;case"Ed25519":case"EdDSA":t="Ed25519"===e.crv}return t})),{0:s,length:o}=i;if(0===o)throw new H;if(1!==o){const e=new O,t=this.#g;throw e[Symbol.asyncIterator]=async function*(){for(const e of i)try{yield await St(t,e,r)}catch{}},e}return St(this.#g,s,r)}}async function St(e,t,r){const n=e.get(t)||e.set(t,{}).get(t);if(void 0===n[r]){const e=await Ce({...t,ext:!0},r);if(e instanceof Uint8Array||"public"!==e.type)throw new T("JSON Web Key Set members must be public keys");n[r]=e}return n[r]}function At(e){const t=new Et(e),r=async(e,r)=>t.getKey(e,r);return Object.defineProperties(r,{jwks:{value:()=>structuredClone(t.jwks()),enumerable:!1,configurable:!1,writable:!1}}),r}let Ct;"undefined"!=typeof navigator&&navigator.userAgent?.startsWith?.("Mozilla/5.0 ")||(Ct="jose/v6.0.11");const Pt=Symbol(),Tt=Symbol();class Ht{#v;#b;#E;#S;#A;#C;#P;#T;#H;#O;constructor(e,t){if(!(e instanceof URL))throw new TypeError("url must be an instance of URL");var r,n;this.#v=new URL(e.href),this.#b="number"==typeof t?.timeoutDuration?t?.timeoutDuration:5e3,this.#E="number"==typeof t?.cooldownDuration?t?.cooldownDuration:3e4,this.#S="number"==typeof t?.cacheMaxAge?t?.cacheMaxAge:6e5,this.#P=new Headers(t?.headers),Ct&&!this.#P.has("User-Agent")&&this.#P.set("User-Agent",Ct),this.#P.has("accept")||(this.#P.set("accept","application/json"),this.#P.append("accept","application/jwk-set+json")),this.#T=t?.[Pt],void 0!==t?.[Tt]&&(this.#O=t?.[Tt],r=t?.[Tt],n=this.#S,"object"==typeof r&&null!==r&&"uat"in r&&"number"==typeof r.uat&&!(Date.now()-r.uat>=n)&&"jwks"in r&&z(r.jwks)&&Array.isArray(r.jwks.keys)&&Array.prototype.every.call(r.jwks.keys,z)&&(this.#A=this.#O.uat,this.#H=At(this.#O.jwks)))}pendingFetch(){return!!this.#C}coolingDown(){return"number"==typeof this.#A&&Date.now()<this.#A+this.#E}fresh(){return"number"==typeof this.#A&&Date.now()<this.#A+this.#S}jwks(){return this.#H?.jwks()}async getKey(e,t){this.#H&&this.fresh()||await this.reload();try{return await this.#H(e,t)}catch(r){if(r instanceof H&&!1===this.coolingDown())return await this.reload(),this.#H(e,t);throw r}}async reload(){this.#C&&("undefined"!=typeof WebSocketPair||"undefined"!=typeof navigator&&"Cloudflare-Workers"===navigator.userAgent||"undefined"!=typeof EdgeRuntime&&"vercel"===EdgeRuntime)&&(this.#C=void 0),this.#C||=async function(e,t,r,n=fetch){const a=await n(e,{method:"GET",signal:r,redirect:"manual",headers:t}).catch((e=>{if("TimeoutError"===e.name)throw new k;throw e}));if(200!==a.status)throw new m("Expected 200 OK from the JSON Web Key Set HTTP response");try{return await a.json()}catch{throw new m("Failed to parse the JSON Web Key Set HTTP response as JSON")}}(this.#v.href,this.#P,AbortSignal.timeout(this.#b),this.#T).then((e=>{this.#H=At(e),this.#O&&(this.#O.uat=Date.now(),this.#O.jwks=e),this.#A=Date.now(),this.#C=void 0})).catch((e=>{throw this.#C=void 0,e})),await this.#C}}function Ot(e,t){const r=new Ht(e,t),n=async(e,t)=>r.getKey(e,t);return Object.defineProperties(n,{coolingDown:{get:()=>r.coolingDown(),enumerable:!0,configurable:!1},fresh:{get:()=>r.fresh(),enumerable:!0,configurable:!1},reload:{value:()=>r.reload(),enumerable:!0,configurable:!1,writable:!1},reloading:{get:()=>r.pendingFetch(),enumerable:!0,configurable:!1},jwks:{value:()=>r.jwks(),enumerable:!0,configurable:!1,writable:!1}}),n}class kt{#h;constructor(e={}){this.#h=new st(e)}encode(){return`${f(JSON.stringify({alg:"none"}))}.${f(this.#h.data())}.`}setIssuer(e){return this.#h.iss=e,this}setSubject(e){return this.#h.sub=e,this}setAudience(e){return this.#h.aud=e,this}setJti(e){return this.#h.jti=e,this}setNotBefore(e){return this.#h.nbf=e,this}setExpirationTime(e){return this.#h.exp=e,this}setIssuedAt(e){return this.#h.iat=e,this}static decode(e,t){if("string"!=typeof e)throw new C("Unsecured JWT must be a string");const{0:r,1:n,2:a,length:i}=e.split(".");if(3!==i||""!==a)throw new C("Invalid Unsecured JWT");let o;try{if(o=JSON.parse(s.decode(y(r))),"none"!==o.alg)throw new Error}catch{throw new C("Invalid Unsecured JWT")}return{payload:it(o,y(n),t),header:o}}}function Mt(e){let t;if("string"==typeof e){const r=e.split(".");3!==r.length&&5!==r.length||([t]=r)}else if("object"==typeof e&&e){if(!("protected"in e))throw new TypeError("Token does not contain a Protected Header");t=e.protected}try{if("string"!=typeof t||!t)throw new Error;const e=JSON.parse(s.decode(y(t)));if(!z(e))throw new Error;return e}catch{throw new TypeError("Invalid Token or Protected Header formatting")}}function Kt(e){if("string"!=typeof e)throw new C("JWTs must use Compact JWS serialization, JWT must be a string");const{1:t,length:r}=e.split(".");if(5===r)throw new C("Only JWTs using Compact JWS serialization can be decoded");if(3!==r)throw new C("Invalid JWT");if(!t)throw new C("JWTs must contain a payload");let n,a;try{n=y(t)}catch{throw new C("Failed to base64url decode the payload")}try{a=JSON.parse(s.decode(n))}catch{throw new C("Failed to parse the decoded payload as JSON")}if(!z(a))throw new C("Invalid JWT Claims Set");return a}function Dt(e){const t=e?.modulusLength??2048;if("number"!=typeof t||t<2048)throw new b("Invalid or unsupported modulusLength option provided, 2048 bits or larger keys must be used");return t}async function Rt(e,t){let r,n;switch(e){case"PS256":case"PS384":case"PS512":r={name:"RSA-PSS",hash:`SHA-${e.slice(-3)}`,publicExponent:new Uint8Array([1,0,1]),modulusLength:Dt(t)},n=["sign","verify"];break;case"RS256":case"RS384":case"RS512":r={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.slice(-3)}`,publicExponent:new Uint8Array([1,0,1]),modulusLength:Dt(t)},n=["sign","verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":r={name:"RSA-OAEP",hash:`SHA-${parseInt(e.slice(-3),10)||1}`,publicExponent:new Uint8Array([1,0,1]),modulusLength:Dt(t)},n=["decrypt","unwrapKey","encrypt","wrapKey"];break;case"ES256":r={name:"ECDSA",namedCurve:"P-256"},n=["sign","verify"];break;case"ES384":r={name:"ECDSA",namedCurve:"P-384"},n=["sign","verify"];break;case"ES512":r={name:"ECDSA",namedCurve:"P-521"},n=["sign","verify"];break;case"Ed25519":case"EdDSA":n=["sign","verify"],r={name:"Ed25519"};break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{n=["deriveBits"];const e=t?.crv??"P-256";switch(e){case"P-256":case"P-384":case"P-521":r={name:"ECDH",namedCurve:e};break;case"X25519":r={name:"X25519"};break;default:throw new b("Invalid or unsupported crv option provided, supported values are P-256, P-384, P-521, and X25519")}break}default:throw new b('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}return crypto.subtle.generateKey(r,t?.extractable??!1,n)}async function It(e,t){let r,n,a;switch(e){case"HS256":case"HS384":case"HS512":r=parseInt(e.slice(-3),10),n={name:"HMAC",hash:`SHA-${r}`,length:r},a=["sign","verify"];break;case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return r=parseInt(e.slice(-3),10),crypto.getRandomValues(new Uint8Array(r>>3));case"A128KW":case"A192KW":case"A256KW":r=parseInt(e.slice(1,4),10),n={name:"AES-KW",length:r},a=["wrapKey","unwrapKey"];break;case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":case"A128GCM":case"A192GCM":case"A256GCM":r=parseInt(e.slice(1,4),10),n={name:"AES-GCM",length:r},a=["encrypt","decrypt"];break;default:throw new b('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}return crypto.subtle.generateKey(n,t?.extractable??!1,a)}const Ft="WebCryptoAPI"},83:e=>{e.exports={visa:{niceType:"Visa",type:"visa",patterns:[4],gaps:[4,8,12],lengths:[16,18,19],code:{name:"CVV",size:3}},mastercard:{niceType:"Mastercard",type:"mastercard",patterns:[[51,55],[2221,2229],[223,229],[23,26],[270,271],2720],gaps:[4,8,12],lengths:[16],code:{name:"CVC",size:3}},"american-express":{niceType:"American Express",type:"american-express",patterns:[34,37],gaps:[4,10],lengths:[15],code:{name:"CID",size:4}},"diners-club":{niceType:"Diners Club",type:"diners-club",patterns:[[300,305],36,38,39],gaps:[4,10],lengths:[14,16,19],code:{name:"CVV",size:3}},discover:{niceType:"Discover",type:"discover",patterns:[6011,[644,649],65],gaps:[4,8,12],lengths:[16,19],code:{name:"CID",size:3}},jcb:{niceType:"JCB",type:"jcb",patterns:[2131,1800,[3528,3589]],gaps:[4,8,12],lengths:[16,17,18,19],code:{name:"CVV",size:3}},unionpay:{niceType:"UnionPay",type:"unionpay",patterns:[620,[62100,62182],[62184,62187],[62185,62197],[62200,62205],[622010,622999],622018,[62207,62209],[623,626],6270,6272,6276,[627700,627779],[627781,627799],[6282,6289],6291,6292,810,[8110,8131],[8132,8151],[8152,8163],[8164,8171]],gaps:[4,8,12],lengths:[14,15,16,17,18,19],code:{name:"CVN",size:3}},maestro:{niceType:"Maestro",type:"maestro",patterns:[493698,[5e5,504174],[504176,506698],[506779,508999],[56,59],63,67,6],gaps:[4,8,12],lengths:[12,13,14,15,16,17,18,19],code:{name:"CVC",size:3}},elo:{niceType:"Elo",type:"elo",patterns:[401178,401179,438935,457631,457632,431274,451416,457393,504175,[506699,506778],[509e3,509999],627780,636297,636368,[650031,650033],[650035,650051],[650405,650439],[650485,650538],[650541,650598],[650700,650718],[650720,650727],[650901,650978],[651652,651679],[655e3,655019],[655021,655058]],gaps:[4,8,12],lengths:[16],code:{name:"CVE",size:3}},mir:{niceType:"Mir",type:"mir",patterns:[[2200,2204]],gaps:[4,8,12],lengths:[16,17,18,19],code:{name:"CVP2",size:3}},hiper:{niceType:"Hiper",type:"hiper",patterns:[637095,63737423,63743358,637568,637599,637609,637612],gaps:[4,8,12],lengths:[16],code:{name:"CVC",size:3}},hipercard:{niceType:"Hipercard",type:"hipercard",patterns:[606282],gaps:[4,8,12],lengths:[16],code:{name:"CVC",size:3}}}},101:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.findBestMatch=void 0,t.findBestMatch=function(e){return function(e){var t=e.filter((function(e){return e.matchStrength})).length;return t>0&&t===e.length}(e)?e.reduce((function(e,t){return e?Number(e.matchStrength)<Number(t.matchStrength)?t:e:t})):null}},118:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(a,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function o(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,o)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.LegacyCollector=void 0;const a=r(515),i=r(853),s=r(57),o="RSA-OAEP-256",c="Could not secure the card for storage. Please try again later.",d=[i.CardType.Visa,i.CardType.Mastercard,i.CardType.AmericanExpress,i.CardType.DinersClub,i.CardType.Discover,i.CardType.Jcb,i.CardType.UnionPay,i.CardType.Maestro,i.CardType.Mir,i.CardType.Elo,i.CardType.Hiper,i.CardType.HiperCard];class l extends a.Collector{collect(e){return n(this,void 0,void 0,(function*(){const t=this.createCollectedCard(e);if("local"===this.deployment)return{mode:"legacy",success:!0,localSimulation:!0,card:t,businessUnitId:this.collectOptions.businessUnitId,customerId:this.collectOptions.customerId};const r=yield this.getPublicKey();if("errorDetails"in r)return r;const n=yield this.encryptCard(e,r),a=yield this.tokenizeCard(n);if("errorDetails"in a)return a;const i=yield this.callCoreService(t,a);return null!==i?i:{success:!0,mode:"legacy",card:t,businessUnitId:this.collectOptions.businessUnitId,customerId:this.collectOptions.customerId}}))}getPublicKey(){return n(this,void 0,void 0,(function*(){const e=yield fetch(`${this.collectOptions.pgHost}/Api/publickey`);if(!e.ok)return{mode:"legacy",success:!1,errorCode:"legacyPgPublicKeyFailed",error:c,errorDetails:`Public key request to ${this.collectOptions.pgHost} failed. ${l.responseDetails(e)}`};const t=yield e.json();return{publicJwk:t,publicKey:yield s.importJWK(t,o)}}))}encryptCard(e,t){return n(this,void 0,void 0,(function*(){const r={CardholderName:e[i.FieldType.Name],Number:e[i.FieldType.Number],Cvc:e[i.FieldType.Cvv],ExpMonth:parseInt(e[i.FieldType.Month]),ExpYear:parseInt(e[i.FieldType.Year]),Zip:e[i.FieldType.PostalCode]},n=new s.CompactEncrypt((new TextEncoder).encode(JSON.stringify(r))).setProtectedHeader({alg:o,enc:"A256CBC-HS512",jwk:t.publicJwk});return yield n.encrypt(t.publicKey)}))}tokenizeCard(e){return n(this,void 0,void 0,(function*(){const t={JweToken:e},r=yield fetch(`${this.collectOptions.pgHost}/Api/StoreEncryptedCreditCard?key=${this.collectOptions.pgApiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)return{mode:"legacy",success:!1,errorCode:"legacyPgTokenizeFailed",error:c,errorDetails:`Tokenization request to ${this.collectOptions.pgHost} failed. ${l.responseDetails(r)}`};const n=yield r.json();return n.PgRequestId&&n.Token?{pgRequestId:n.PgRequestId,token:n.Token}:{mode:"legacy",success:!1,errorCode:"legacyPgTokenizeFailed",error:c,errorDetails:`Tokenization request to ${this.collectOptions.pgHost} returned an invalid result. ${l.responseDetails(r)}`}}))}callCoreService(e,t){return n(this,void 0,void 0,(function*(){const r={tenantId:this.collectOptions.tenantId,businessUnitId:this.collectOptions.businessUnitId,customerId:this.collectOptions.customerId,pgRequestId:t.pgRequestId,pgToken:t.token,ownerName:e.ownerName,last4:e.last4,expiryMonth:e.expiryMonth,expiryYear:e.expiryYear,postalCode:e.postalCode,type:d.indexOf(e.cardType)+1},n=yield fetch(`${this.getCoreUrl()}/publicapi/v1/webfields/postcardevent`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.collectOptions.paymentsServiceJwt}`},body:JSON.stringify(r)});return n.ok?null:{mode:"legacy",success:!1,errorCode:"legacyCoreServiceFailed",error:"Could not store the card. Please try again later.",errorDetails:`Core service request failed. ${l.responseDetails(n)}`}}))}static responseDetails(e){return`Status=${e.status} (${e.statusText})`}}t.LegacyCollector=l},119:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.parseDate=void 0;var n=r(432),a=r(985);t.parseDate=function(e){var t;if(/^\d{4}-\d{1,2}$/.test(e)?t=e.split("-").reverse():/\//.test(e)?t=e.split(/\s*\/\s*/g):/\s/.test(e)&&(t=e.split(/ +/g)),(0,a.isArray)(t))return{month:t[0]||"",year:t.slice(1).join()};var r,i,s,o=(r=e,0===(s=Number(r[0]))?2:s>1||1===s&&Number(r[1])>2?1:1===s?(i=r.substr(1),(0,n.expirationYear)(i).isPotentiallyValid?1:2):5===r.length?1:r.length>5?2:1),c=e.substr(0,o);return{month:c,year:e.substr(c.length)}}},134:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),t.CssModifier=void 0;class n{modify(e,t){var n,a;t=Object.fromEntries(Object.entries(t).filter((([e,t])=>"string"!=typeof t||/[<>`{}]/.test(t)||/\b(expression|url|javascript|data|uri)\b/i.test(t)?(console.warn(`Unsafe value in style ${e}`),!1):!!r.allowedStyles.includes(e)||(console.warn(`Unsupported style ${e}`),!1))));var i=Array.from(document.head.children).find((t=>{var r;return"STYLE"===t.tagName&&(null===(r=t.innerText)||void 0===r?void 0:r.includes(`${e} {`))}));i||(i=document.createElement("style"),document.head.appendChild(i));const s=null!==(a=null===(n=i.innerText)||void 0===n?void 0:n.matchAll(r.ruleRegex))&&void 0!==a?a:[],o=Object.fromEntries(Array.from(s).map((([e,t,r])=>[t,r.trim()]))),c=Object.assign(Object.assign({},o),t),d=Object.entries(c).map((([e,t])=>`${e}: ${t};`)).join(" ");i.innerText=`${e} { ${d} }`}}t.CssModifier=n,r=n,n.ruleRegex=/([^{\s]+)\s*:\s*([^;{]+);/g,n.allowedStylesTemp={"-moz-appearance":void 0,"-moz-osx-font-smoothing":void 0,"-moz-tap-highlight-color":void 0,"-moz-transition":void 0,"-webkit-appearance":void 0,"-webkit-osx-font-smoothing":void 0,"-webkit-tap-highlight-color":void 0,"-webkit-transition":void 0,"border-radius":void 0,"box-shadow":void 0,"font-family":void 0,"font-optical-sizing":void 0,"font-size":void 0,"font-size-adjust":void 0,"font-stretch":void 0,"font-style":void 0,"font-variant":void 0,"font-variant-alternates":void 0,"font-variant-caps":void 0,"font-variant-east-asian":void 0,"font-variant-ligatures":void 0,"font-variant-numeric":void 0,"font-variation-settings":void 0,"font-weight":void 0,"letter-spacing":void 0,"line-height":void 0,"padding-bottom":void 0,"padding-left":void 0,"padding-right":void 0,"padding-top":void 0,"text-shadow":void 0,appearance:void 0,background:void 0,border:void 0,color:void 0,direction:void 0,font:void 0,height:void 0,opacity:void 0,outline:void 0,"outline-offset":void 0,padding:void 0,transition:void 0},n.allowedStyles=Object.keys(r.allowedStylesTemp)},156:function(e,t,r){var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,a)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),a(r(796),t),a(r(887),t),a(r(853),t),a(r(725),t)},183:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.unmask=void 0,t.unmask=(e,t)=>e?(e=e.replace(/\W/gi,""),t?e.slice(0,t.replace(/\W/gi,"").length):e):e},209:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.addMatchingCardsToResults=void 0;var n=r(788),a=r(256);t.addMatchingCardsToResults=function(e,t,r){var i,s;for(i=0;i<t.patterns.length;i++){var o=t.patterns[i];if((0,a.matches)(e,o)){var c=(0,n.clone)(t);s=Array.isArray(o)?String(o[0]).length:String(o).length,e.length>=s&&(c.matchStrength=s),r.push(c);break}}}},234:function(e,t,r){var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,a)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=(this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return a(t,e),t})(r(961)),s=r(537),o=r(533),c=r(301),d=r(703),l=r(432),p=r(268),u=r(870),h={creditCardType:i,cardholderName:s.cardholderName,number:o.cardNumber,expirationDate:c.expirationDate,expirationMonth:d.expirationMonth,expirationYear:l.expirationYear,cvv:p.cvv,postalCode:u.postalCode};e.exports=h},256:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.matches=void 0,t.matches=function(e,t){return Array.isArray(t)?function(e,t,r){var n=String(t).length,a=e.substr(0,n),i=parseInt(a,10);return t=parseInt(String(t).substr(0,a.length),10),r=parseInt(String(r).substr(0,a.length),10),i>=t&&i<=r}(e,t[0],t[1]):function(e,t){return(t=String(t)).substring(0,e.length)===e.substring(0,t.length)}(e,t)}},268:(e,t)=>{function r(e,t){return{isValid:e,isPotentiallyValid:t}}Object.defineProperty(t,"__esModule",{value:!0}),t.cvv=void 0,t.cvv=function(e,t){return void 0===t&&(t=3),t=t instanceof Array?t:[t],"string"!=typeof e?r(!1,!1):/^\d*$/.test(e)?function(e,t){for(var r=0;r<e.length;r++)if(t===e[r])return!0;return!1}(t,e.length)?r(!0,!0):e.length<Math.min.apply(null,t)?r(!1,!0):e.length>function(e){for(var t=3,r=0;r<e.length;r++)t=e[r]>t?e[r]:t;return t}(t)?r(!1,!1):r(!0,!0):r(!1,!1)}},301:function(e,t,r){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},n.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.expirationDate=void 0;var a=r(119),i=r(703),s=r(432);function o(e,t,r,n){return{isValid:e,isPotentiallyValid:t,month:r,year:n}}t.expirationDate=function(e,t){var r;if("string"==typeof e)e=e.replace(/^(\d\d) (\d\d(\d\d)?)$/,"$1/$2"),r=(0,a.parseDate)(String(e));else{if(null===e||"object"!=typeof e)return o(!1,!1,null,null);var c=n({},e);r={month:String(c.month),year:String(c.year)}}var d=(0,i.expirationMonth)(r.month),l=(0,s.expirationYear)(r.year,t);if(d.isValid){if(l.isCurrentYear){var p=d.isValidForThisYear;return o(p,p,r.month,r.year)}if(l.isValid)return o(!0,!0,r.month,r.year)}return d.isPotentiallyValid&&l.isPotentiallyValid?o(!1,!0,null,null):o(!1,!1,null,null)}},327:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.validateCustomFonts=t.FieldTypeValues=void 0;const n=r(853);t.FieldTypeValues=Object.values(n.FieldType);const a=[/\.st\.dev$/,/\.servicetitan\.com$/,/^fonts\.googleapis\.com$/];t.validateCustomFonts=e=>{e.forEach((e=>{var t=new URL(e.url);if(!a.some((e=>t.hostname.match(e))))throw new Error(`CustomFont domain ${t.hostname} is not whitelisted. Allowed hosts: *.st.dev, *.servicetitan.com, fonts.googleapis.com`);if("font-file"===e.type&&!e.familyName)throw new Error("CustomFont with type 'font-file' must have a familyName defined.")}))}},348:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.prepareMaskInputs=void 0;const n=r(478);t.prepareMaskInputs=()=>{document.querySelectorAll("[data-mask]").forEach((e=>(0,n.input)(e,a(e.dataset.mask))))};const a=e=>JSON.parse(e.replace(/'/g,'"'))},382:function(e,t,r){var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,a)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),a(r(612),t),a(r(724),t),a(r(478),t),a(r(524),t),a(r(733),t),a(r(348),t),a(r(183),t),a(r(938),t)},394:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.currencyLocale=void 0,t.currencyLocale={AD:"EUR",AE:"AED",AF:"AFN",AG:"XCD",AI:"XCD",AL:"ALL",AM:"AMD",AO:"AOA",AR:"ARS",AS:"USD",AT:"EUR",AU:"AUD",AW:"AWG",AX:"EUR",AZ:"AZN",BA:"BAM",BB:"BBD",BD:"BDT",BE:"EUR",BF:"XOF",BG:"BGN",BH:"BHD",BI:"BIF",BJ:"XOF",BL:"EUR",BM:"BMD",BN:"BND",BO:"BOB",BQ:"USD",BR:"BRL",BS:"BSD",BT:"BTN",BV:"NOK",BW:"BWP",BY:"BYN",BZ:"BZD",CA:"CAD",CC:"AUD",CD:"CDF",CF:"XAF",CG:"XAF",CH:"CHF",CI:"XOF",CK:"NZD",CL:"CLP",CM:"XAF",CN:"CNY",CO:"COP",CR:"CRC",CU:"CUP",CV:"CVE",CW:"ANG",CX:"AUD",CY:"EUR",CZ:"CZK",DE:"EUR",DJ:"DJF",DK:"DKK",DM:"XCD",DO:"DOP",DZ:"DZD",EC:"USD",EE:"EUR",EG:"EGP",EH:"MAD",ER:"ERN",ES:"EUR",ET:"ETB",FI:"EUR",FJ:"FJD",FK:"FKP",FM:"USD",FO:"DKK",FR:"EUR",GA:"XAF",GB:"GBP",GD:"XCD",GE:"GEL",GF:"EUR",GG:"GBP",GH:"GHS",GI:"GIP",GL:"DKK",GM:"GMD",GN:"GNF",GP:"EUR",GQ:"XAF",GR:"EUR",GS:"GBP",GT:"GTQ",GU:"USD",GW:"XOF",GY:"GYD",HK:"HKD",HM:"AUD",HN:"HNL",HR:"HRK",HT:"HTG",HU:"HUF",ID:"IDR",IE:"EUR",IL:"ILS",IM:"GBP",IN:"INR",IO:"USD",IQ:"IQD",IR:"IRR",IS:"ISK",IT:"EUR",JE:"GBP",JM:"JMD",JO:"JOD",JP:"JPY",KE:"KES",KG:"KGS",KH:"KHR",KI:"AUD",KM:"KMF",KN:"XCD",KP:"KPW",KR:"KRW",KW:"KWD",KY:"KYD",KZ:"KZT",LA:"LAK",LB:"LBP",LC:"XCD",LI:"CHF",LK:"LKR",LR:"LRD",LS:"LSL",LT:"EUR",LU:"EUR",LV:"EUR",LY:"LYD",MA:"MAD",MC:"EUR",MD:"MDL",ME:"EUR",MF:"EUR",MG:"MGA",MH:"USD",MK:"MKD",ML:"XOF",MM:"MMK",MN:"MNT",MO:"MOP",MP:"USD",MQ:"EUR",MR:"MRO",MS:"XCD",MT:"EUR",MU:"MUR",MV:"MVR",MW:"MWK",MX:"MXN",MY:"MYR",MZ:"MZN",NA:"NAD",NC:"XPF",NE:"XOF",NF:"AUD",NG:"NGN",NI:"NIO",NL:"EUR",NO:"NOK",NP:"NPR",NR:"AUD",NU:"NZD",NZ:"NZD",OM:"OMR",PA:"PAB",PE:"PEN",PF:"XPF",PG:"PGK",PH:"PHP",PK:"PKR",PL:"PLN",PM:"EUR",PN:"NZD",PR:"USD",PS:"ILS",PT:"EUR",PW:"USD",PY:"PYG",QA:"QAR",RE:"EUR",RO:"RON",RS:"RSD",RU:"RUB",RW:"RWF",SA:"SAR",SB:"SBD",SC:"SCR",SD:"SDG",SE:"SEK",SG:"SGD",SH:"SHP",SI:"EUR",SJ:"NOK",SK:"EUR",SL:"SLL",SM:"EUR",SN:"XOF",SO:"SOS",SR:"SRD",ST:"STD",SV:"SVC",SX:"ANG",SY:"SYP",SZ:"SZL",TC:"USD",TD:"XAF",TF:"EUR",TG:"XOF",TH:"THB",TJ:"TJS",TK:"NZD",TL:"USD",TM:"TMT",TN:"TND",TO:"TOP",TR:"TRY",TT:"TTD",TV:"AUD",TW:"TWD",TZ:"TZS",UA:"UAH",UG:"UGX",UM:"USD",US:"USD",UY:"UYU",UZ:"UZS",VA:"EUR",VC:"XCD",VE:"VEF",VG:"USD",VI:"USD",VN:"VND",VU:"VUV",WF:"XPF",WS:"WST",YE:"YER",YT:"EUR",ZA:"ZAR",ZM:"ZMW",ZW:"ZWL"}},407:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FieldFrameMonthYear=void 0;const n=r(979),a=r(853),i=r(382);class s extends n.FieldFrame{constructor(e,t,r,n){super(e,t,r,n)}onInitialized(){switch(this.fieldType){case a.FieldType.Month:this.placeholder="MM",i.input(this.input,["dd"]);break;case a.FieldType.Year:this.placeholder="YYYY",i.input(this.input,["dddd"])}}validate(e){var t,r;if(""===e)return{valid:"maybe",error:`Invalid ${this.fieldType}`};if(isNaN(parseInt(e,10)))return{valid:!1,error:`Invalid ${this.fieldType}`};let n,i,o=(new Date).getFullYear(),c=(new Date).getMonth()+1;switch(this.fieldType){case a.FieldType.Month:if(n=parseInt(e,10),0===n&&1===e.length)return{valid:"maybe",error:"Invalid month"};if(n<1||n>12)return{valid:!1,error:"Invalid month"};let r=this.getFieldValue(a.FieldType.Year);i=4===(null===(t=null==r?void 0:r.value)||void 0===t?void 0:t.length)?parseInt(r.value,10):void 0,isNaN(i)&&(i=void 0);break;case a.FieldType.Year:let s=parseInt(e.padEnd(4,"0"),10);if(parseInt(e.padEnd(4,"9"),10)<o)return{valid:!1,error:"Expired"};if(s>o+20)return{valid:!1,error:"Invalid year"};if(e.length<4)return{valid:"maybe",error:"Invalid year"};i=parseInt(e,10);let c=this.getFieldValue(a.FieldType.Month);n=c?parseInt(c.value,10):void 0,isNaN(n)&&(n=void 0)}if(void 0!==n&&null!=i){if(i<o||i===o&&n<c)return{valid:!1,error:"Expired"};let e=null!==(r=this.config.minExpiryWindowMonths)&&void 0!==r?r:0,t=new Date;if(t.setMonth(c-1+e),new Date(i,n-1,s.getDaysInMonth(i,n-1))<t)return{valid:!1,error:`Cannot expire before ${t.getMonth()+1}/${t.getFullYear()}`}}return{valid:!0,complete:this.fieldType===a.FieldType.Year||2===e.length}}static isLeapYear(e){return e%4==0&&e%100!=0||e%400==0}static getDaysInMonth(e,t){return[31,s.isLeapYear(e)?29:28,31,30,31,30,31,31,30,31,30,31][t]}}t.FieldFrameMonthYear=s},432:(e,t)=>{function r(e,t,r){return{isValid:e,isPotentiallyValid:t,isCurrentYear:r||!1}}Object.defineProperty(t,"__esModule",{value:!0}),t.expirationYear=void 0,t.expirationYear=function(e,t){var n;if(void 0===t&&(t=19),"string"!=typeof e)return r(!1,!1);if(""===e.replace(/\s/g,""))return r(!1,!0);if(!/^\d*$/.test(e))return r(!1,!1);var a=e.length;if(a<2)return r(!1,!0);var i=(new Date).getFullYear();if(3===a)return r(!1,e.slice(0,2)===String(i).slice(0,2));if(a>4)return r(!1,!1);var s=parseInt(e,10),o=Number(String(i).substr(2,2)),c=!1;if(2===a){if(String(i).substr(0,2)===e)return r(!1,!0);n=o===s,c=s>=o&&s<=o+t}else 4===a&&(n=i===s,c=s>=i&&s<=i+t);return r(c,c,n)}},458:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FieldFrameCvv=void 0;const n=r(979),a=r(853),i=r(234),s=r(382);class o extends n.FieldFrame{constructor(e,t,r){super(a.FieldType.Cvv,e,t,r)}onInitialized(){this.setAttributes("CVC",4)}validate(e){let t=this.getFieldValue(a.FieldType.Number);if(null==t?void 0:t.data){let r=i.creditCardType.getTypeInfo(t.data);if(r)return this.setAttributes(`${r.code.size}-digit ${r.code.name}`,r.code.size),this.testCVV(e,r.code.size,r.code.size,r.code.name)}return this.setAttributes("CVC",4),this.testCVV(e,3,4,"CVC")}testCVV(e,t,r,n){if(new RegExp(`^\\d{${t},${r}}$`).test(e))return{valid:!0,complete:e.length===r};const a=`Invalid ${n} (${r===t?`${t} digits`:`${t}-${r} digits`})`;return new RegExp(`^\\d{0,${t-1}}$`).test(e)?{valid:"maybe",error:a}:{valid:!1,error:a}}setAttributes(e,t){var r;this.placeholder=e,this.input.removeAttribute("maxLength"),null===(r=this.removeSmask)||void 0===r||r.call(this),this.removeSmask=s.input(this.input,["d".repeat(t)])}}t.FieldFrameCvv=o},478:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.input=t.inputDate=t.inputCurrency=t.inputNumber=void 0;const n=r(612),a=r(724),i=r(524),s=r(733),o=r(938);t.inputNumber=e=>{const t=(0,o.unmaskNumber)(e);return isNaN(t)?"":(0,s.numberFormat)(t)},t.inputCurrency=e=>{const t=(0,o.unmaskNumber)(e)/100;return isNaN(t)?"":(0,n.currencyFormat)(t)},t.inputDate=(e,t=navigator.language)=>{if(!e)return e;const r=(0,a.getDatePattern)(),n=(0,a.getComputedDate)(e),s=(0,i.mask)(n,[r]),o=(0,a.date)(s,t);if(!(0,a.isValidDate)(o))throw new Error("Invalid date");return(0,i.mask)(e,[r])},t.input=(e,r)=>{var s,o;if(!e||"object"!=typeof e)throw Error("Element not found.");if(!r)throw ReferenceError("Pattern should be an array");if(!Array.isArray(r))throw ReferenceError("Pattern should be an array");const[c]=r.sort(((e,t)=>e.length-t.length));let d;switch(c){case"currency":e.placeholder=(0,n.currencyFormat)(0),d=()=>{e.value=(0,t.inputCurrency)(e.value)};break;case"number":d=()=>{e.value=(0,t.inputNumber)(e.value)};break;case"date":{const r=(0,a.getDatePattern)();e.minLength=e.maxLength=r.length,e.pattern=`.{${r.length},${r.length}}`,d=()=>{try{const r=(0,t.inputDate)(e.value);e.value=r,e.defaultValue=r}catch(t){e.value=e.defaultValue}};break}default:e.minLength=c.length,e.maxLength=(null===(s=r.at(-1))||void 0===s?void 0:s.length)||c.length,e.pattern=`.{${c.length},${(null===(o=r.at(-1))||void 0===o?void 0:o.length)||c.length}}`,d=()=>{e.value=(0,i.mask)(e.value,r)}}return e.value&&d(),e.addEventListener("input",d),()=>{e.removeEventListener("input",d)}}},515:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Collector=void 0;const n=r(853);t.Collector=class{constructor(e,t){this.deployment=e,this.collectOptions=t}getCoreUrl(){switch(this.deployment){case"local":return null;case"prod":return"https://modularpayments.wus201.go.prod.modularpayments.srv.servicetitan.com";case"stage":return"https://modularpayments.wus201.qa.devtest.modularpayments.srv.st.dev";default:throw new Error(`Unknown deployment: ${this.deployment}`)}}createCollectedCard(e){return{ownerName:e[n.FieldType.Name],last4:e[n.FieldType.Number].match(/(\d{4})$/)[1],expiryMonth:parseInt(e[n.FieldType.Month]),expiryYear:parseInt(e[n.FieldType.Year]),cardType:e.cardType,postalCode:e[n.FieldType.PostalCode]}}}},524:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.mask=void 0;const n=r(766),a=r(183);t.mask=(e,t)=>{if(!e)return"";if(!t)throw ReferenceError("Value or pattern not found.");if(!Array.isArray(t))throw ReferenceError("Pattern should be an array");t.sort(((e,t)=>e.length-t.length));let r="";const n=(0,a.unmask)(e).length;for(let s=0;s<t.length;s++){const o=t[s];if(n<=(0,a.unmask)(o).length){const t=i(e,o);t.length>r.length&&(r=t)}}return r};const i=(e,t)=>{let r="";for(let i=(0,a.unmask)(e,t),s=(0,a.unmask)(t),o=t.length,c=0,d=0;c<o&&i[d];c++){const e=n.tokens[s[d]],a=t[c],o=i[d];if(!e.test(o))break;/\W/.test(a)?r+=a:(r+=e.transform(o),d++)}return r}},533:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.cardNumber=void 0;var n=r(876),a=r(961);function i(e,t,r){return{card:e,isPotentiallyValid:t,isValid:r}}t.cardNumber=function(e,t){var r,s;if(void 0===t&&(t={}),"string"!=typeof e&&"number"!=typeof e)return i(null,!1,!1);var o=String(e).replace(/-|\s/g,"");if(!/^\d*$/.test(o))return i(null,!1,!1);var c=a(o);if(0===c.length)return i(null,!1,!1);if(1!==c.length)return i(null,!0,!1);var d=c[0];if(t.maxLength&&o.length>t.maxLength)return i(d,!1,!1);r=!0===t.skipLuhnValidation||d.type===a.types.UNIONPAY&&!0!==t.luhnValidateUnionPay||n(o),s=Math.max.apply(null,d.lengths),t.maxLength&&(s=Math.min(t.maxLength,s));for(var l=0;l<d.lengths.length;l++)if(d.lengths[l]===o.length)return i(d,o.length<s||r,r);return i(d,o.length<s,!1)}},537:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.cardholderName=void 0;var r=/^[\d\s-]*$/;function n(e,t){return{isValid:e,isPotentiallyValid:t}}t.cardholderName=function(e){return"string"!=typeof e?n(!1,!1):0===e.length?n(!1,!0):e.length>255?n(!1,!1):r.test(e)?n(!1,!0):n(!0,!0)}},612:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.currencyFormat=void 0;const n=r(733),a=r(394);t.currencyFormat=(e,t=navigator.language,r=a.currencyLocale[t.slice(-2).toLocaleUpperCase()])=>(0,n.numberFormat)(e,t,"currency",{currency:r})},664:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isValidInputType=void 0,t.isValidInputType=function(e){return"string"==typeof e||e instanceof String}},665:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FieldFramePostalCode=void 0;const n=r(979),a=r(853),i=r(382);class s extends n.FieldFrame{constructor(e,t,r){super(a.FieldType.PostalCode,e,t,r)}onInitialized(e){this.localConfigs=Object.entries(s.countryConfigs).filter((([t])=>e.countryCodes.includes(t))).map((([e,t])=>t)),this.placeholder=this.localConfigs.map((e=>e.placeholder)).join(" / "),i.input(this.input,this.localConfigs.map((e=>e.mask)))}validate(e){e=e.replace(/\s+/g,"");const t=this.localConfigs.filter((t=>t.regex.test(e)));return t.length>0?{valid:!0,complete:t[0].validMeansComplete}:this.localConfigs.some((t=>t.partialRegex.test(e)))?{valid:"maybe",error:`Invalid ${this.placeholder}`}:{valid:!1,error:`Invalid ${this.placeholder}`}}}t.FieldFramePostalCode=s,s.countryConfigs={[a.CountryCode.US]:{placeholder:"ZIP",mask:"ddddd-dddd",regex:/^\d{5}(-\d{4})?$/,partialRegex:/^\d{0,5}(-\d{0,4})?$/,validMeansComplete:!1},[a.CountryCode.CA]:{placeholder:"Postal Code",mask:"AdA dAd",regex:/^[A-Za-z]\d[A-Za-z]\d[A-Za-z]\d$/,partialRegex:/^[A-Za-z]\d?[A-Za-z]?\d?[A-Za-z]?\d?$/,validMeansComplete:!0},[a.CountryCode.AU]:{placeholder:"Postcode",mask:"dddd",regex:/^\d{4}$/,partialRegex:/^\d{0,4}$/,validMeansComplete:!0}}},703:(e,t)=>{function r(e,t,r){return{isValid:e,isPotentiallyValid:t,isValidForThisYear:r||!1}}Object.defineProperty(t,"__esModule",{value:!0}),t.expirationMonth=void 0,t.expirationMonth=function(e){var t=(new Date).getMonth()+1;if("string"!=typeof e)return r(!1,!1);if(""===e.replace(/\s/g,"")||"0"===e)return r(!1,!0);if(!/^\d*$/.test(e))return r(!1,!1);var n=parseInt(e,10);if(isNaN(Number(e)))return r(!1,!1);var a=n>0&&n<13;return r(a,a,a&&n>=t)}},724:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.unmaskDate=t.localeTime=t.localeDate=t.localeDateTime=t.dateTimeFormat=t.date=t.getDatePattern=t.isValidDate=t.getComputedDate=void 0;const r="01/01/1970".replace(/\D/g,"");t.getComputedDate=e=>{const t=e.replace(/\D/g,"");return t+r.slice(t.length)};const n=e=>new Intl.DateTimeFormat(e).formatToParts();t.isValidDate=e=>e instanceof Date&&!isNaN(e.valueOf()),t.getDatePattern=e=>{let t="";return n(e).forEach((({type:e,value:r})=>{"month"===e||"day"===e?t+="dd":"year"===e?t+="dddd":"literal"===e&&(t+=r)})),t},t.date=(e,t)=>{var r;const a=n(t),i=null===(r=a.find((({type:e})=>"literal"===e)))||void 0===r?void 0:r.value,s=e.split(i),{month:o,day:c,year:d}={[a[0].type]:s[0],[a[2].type]:s[1],[a[4].type]:s[2]};return new Date(`${o}/${c}/${d}`)},t.dateTimeFormat=(e,t=navigator.language,r)=>new Intl.DateTimeFormat(t,r).format(e),t.localeDateTime=(e,r=navigator.language,n)=>{if(!e)return e;const a=new Date(e);return(0,t.isValidDate)(a)?(0,t.dateTimeFormat)(a,r,Object.assign({dateStyle:"short",timeStyle:"short"},n)):e},t.localeDate=(e,r=navigator.language,n)=>{if(!e)return e;const a=new Date(e);return(0,t.isValidDate)(a)?(0,t.dateTimeFormat)(a,r,Object.assign({dateStyle:"short"},n)):e},t.localeTime=(e,r=navigator.language,n)=>{if(!e)return e;const a=new Date(e);return(0,t.isValidDate)(a)?(0,t.dateTimeFormat)(a,r,Object.assign({timeStyle:"short"},n)):e},t.unmaskDate=(e,r=navigator.language)=>{const n=(0,t.date)(e,r);return(0,t.isValidDate)(n)?n.toISOString():""}},725:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FieldFrameFactory=void 0;const n=r(458),a=r(407),i=r(800),s=r(38),o=r(665),c=r(853);t.FieldFrameFactory=class{static getFieldInitConfig(e){var t;const r=new URLSearchParams(e),n=r.get("type");if(-1===Object.values(c.FieldType).indexOf(n))throw new Error("invalid field type in query");const a=r.get("formKey");let i;if(i=(null===(t=window.location.ancestorOrigins)||void 0===t?void 0:t.length)>0?window.location.ancestorOrigins[0]:document.referrer?new URL(document.referrer).origin:r.get("formOrigin"),!a||!i)throw new Error("no formKey and/or formOrigin in query");return{fieldType:n,formKey:a,formOrigin:i}}static create(e,t){switch(e.fieldType){case c.FieldType.Number:return new s.FieldFrameNumber(e.formKey,e.formOrigin,t);case c.FieldType.Month:case c.FieldType.Year:return new a.FieldFrameMonthYear(e.fieldType,e.formKey,e.formOrigin,t);case c.FieldType.Cvv:return new n.FieldFrameCvv(e.formKey,e.formOrigin,t);case c.FieldType.PostalCode:return new o.FieldFramePostalCode(e.formKey,e.formOrigin,t);case c.FieldType.Name:return new i.FieldFrameName(e.formKey,e.formOrigin,t);default:throw new Error(`Unknown field type ${e.fieldType}`)}}}},733:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.numberFormat=void 0,t.numberFormat=(e,t=navigator.language,r="decimal",n)=>(n=Object.assign({style:r},n),new Intl.NumberFormat(t,n).format(e))},766:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.tokens=void 0,t.tokens={d:{test:e=>/\d/.test(e),transform:e=>e},a:{test:e=>/[a-z]/i.test(e),transform:e=>e.toLowerCase()},A:{test:e=>/[a-z]/i.test(e),transform:e=>e.toUpperCase()},w:{test:e=>/\w/.test(e),transform:e=>e.toLowerCase()},W:{test:e=>/\w/.test(e),transform:e=>e.toUpperCase()}}},788:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.clone=void 0,t.clone=function(e){return e?JSON.parse(JSON.stringify(e)):null}},796:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Form=void 0;const n=r(327),a=r(997),i=r(853);t.Form=class{constructor(e){var t,r,s,o;if(this.fields={},this.eventPoster={},null===(t=e.limitCardTypes)||void 0===t?void 0:t.find((e=>!Object.values(i.CardType).includes(e))))throw new Error("Invalid card type in limitCardTypes");if(null===(r=e.fieldOrder)||void 0===r?void 0:r.find((e=>!Object.values(i.FieldType).includes(e))))throw new Error("Invalid field type in fieldOrder");if(!(null===(s=e.countryCodes)||void 0===s?void 0:s.length))throw new Error("countryCodes is required");if(null===(o=e.countryCodes)||void 0===o?void 0:o.find((e=>!Object.values(i.CountryCode).includes(e))))throw new Error("Invalid country code in countryCodes");e.customFonts&&(0,n.validateCustomFonts)(e.customFonts);const c={fieldOrder:[i.FieldType.Name,i.FieldType.Number,i.FieldType.Month,i.FieldType.Year,i.FieldType.Cvv,i.FieldType.PostalCode],limitCardTypes:[i.CardType.Visa,i.CardType.Mastercard,i.CardType.AmericanExpress,i.CardType.Discover],minExpiryWindowMonths:0};if(this.options=Object.assign(c,e),6!==new Set(this.options.fieldOrder).size)throw new Error("fieldOrder must contain all six fields.");switch(this.options.deployment){case"local":this.fieldOrigin="http://localhost:8126";break;case"prod":case"stage":this.fieldOrigin="https://stpaymentspciprod.blob.core.windows.net";break;default:throw new Error("unknown deployment")}this.formKey=Math.random().toString(),this.eventManager=new a.FormEventManagerImpl(this.eventPoster),this.windowMessageListener=e=>this.handleFieldMessage(e)}get events(){return this.eventManager}mount(e){this.validateMounted(!1);const t=document.querySelectorAll(e);if(0===t.length)throw new Error(`No root with ${e}`);if(t.length>1)throw new Error(`More than one root with ${e}`);const r=this.rootElement=t[0],n=Object.values(i.FieldType).map((t=>{const n=`[data-webfield=${t}]`,a=r.querySelectorAll(n);if(0===a.length)throw new Error(`No container in ${e} with ${n}`);if(a.length>1)throw new Error(`More than one container in ${e} with ${n}`);return{fieldType:t,fieldContainer:a[0]}}));if("true"===r.getAttribute("data-webfields-mounted"))throw new Error(`A different form is already mounted in ${e}`);r.setAttribute("data-webfields-mounted","true");for(const{fieldType:e,fieldContainer:t}of n)this.mountField(t,e);this.eventPoster.postEvent(this,{type:"valid",valid:!1}),window.addEventListener("message",this.windowMessageListener)}unmount(){this.validateMounted(!0);for(const e of Object.values(this.fields))e.frame.remove(),e.frame=null;window.removeEventListener("message",this.windowMessageListener),this.rootElement.removeAttribute("data-webfields-mounted"),this.rootElement=null}style(e){if(this.validateMounted(!0),e.find((e=>"all"!==e.targetField&&-1===n.FieldTypeValues.indexOf(e.targetField))))throw new Error("Invalid field type in style updates");for(const n of e){var t={type:"style",placeholderVisible:n.placeholderVisible,placeholderText:n.placeholderText,updates:n.updates},r="all"===n.targetField?Object.values(i.FieldType):[n.targetField];for(const e of r)this.postMessage(e,t)}}focus(e){this.validateMounted(!0),this.postMessage(e,{type:"focus"})}collect(e){switch(this.validateMounted(!0),e.mode){case"legacy":if(!(e.tenantId&&e.businessUnitId&&e.customerId&&e.pgHost&&e.pgApiKey&&e.paymentsServiceJwt))throw new Error("Legacy collect options must include tenantId, businessUnitId, customerId, pgHost, pgApiKey, and paymentsServiceJwt");break;case"service":throw new Error("Service collection is not yet implemented")}this.postMessage(n.FieldTypeValues[n.FieldTypeValues.length-1],{type:"collect",options:e})}validateMounted(e){if(!!this.rootElement!==e)throw new Error(`Form is ${e?"not":"already"} mounted`)}postMessage(e,t){this.fields[e].frame.contentWindow.postMessage(t,this.fieldOrigin)}handleFieldMessage(e){var t;const r=null===(t=Object.entries(this.fields).find((([t,r])=>r.frame.contentWindow===e.source)))||void 0===t?void 0:t[0];if(!r)return;const n=e.data;switch(n.type){case"initialized":this.handleFieldInitialized(r);break;case"valid":this.handleFieldValidation(r,n);break;case"cardType":this.eventPoster.postEvent(this,{type:"cardType",cardType:n.cardType});break;case"focus":this.eventPoster.postEvent(this,{type:"focus",field:r,hasFocus:n.hasFocus});break;case"collectResult":this.handleCollectResult(n)}}handleFieldInitialized(e){this.fields[e].initialized=!0,!Object.values(this.fields).map((e=>e.initialized)).includes(!1)&&this.eventPoster.postEvent(this,{type:"mounted"})}handleFieldValidation(e,t){this.fields[e].valid=t.valid;const r=!Object.values(this.fields).map((e=>e.valid)).includes(!1);if(this.eventPoster.postEvent(this,{type:"valid",valid:r}),t.complete){const t=this.getNextField(e);this.postMessage(t,{type:"focus"})}}getPreviousField(e){const t=this.options.fieldOrder.indexOf(e);return 0===t?this.options.fieldOrder[this.options.fieldOrder.length-1]:this.options.fieldOrder[t-1]}getNextField(e){const t=this.options.fieldOrder.indexOf(e);return t===this.options.fieldOrder.length-1?this.options.fieldOrder[0]:this.options.fieldOrder[t+1]}handleCollectResult(e){this.eventPoster.postEvent(this,{type:"collectResult",result:e.result})}mountField(e,t){const r=document.createElement("iframe");this.fields[t]={frame:r,valid:!1,initialized:!1};const n=()=>{var e;this.postMessage(t,{type:"initialize",config:{deployment:this.options.deployment,countryCodes:this.options.countryCodes,minExpiryWindowMonths:this.options.minExpiryWindowMonths,limitCardTypes:this.options.limitCardTypes,customFonts:null!==(e=this.options.customFonts)&&void 0!==e?e:[]}}),r.removeEventListener("load",n)},a=encodeURIComponent(window.location.origin);r.style.border="none",r.addEventListener("load",n),r.src=this.createAssetUri(`field.html?type=${t}&formKey=${this.formKey}&formOrigin=${a}`),r.referrerPolicy="origin",e.appendChild(r)}createAssetUri(e){return"local"===this.options.deployment?`${this.fieldOrigin}/webfields/${e}`:`${this.fieldOrigin}/webfields/1.0.50/${e}`}}},800:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FieldFrameName=void 0;const n=r(979),a=r(853);class i extends n.FieldFrame{constructor(e,t,r){super(a.FieldType.Name,e,t,r)}onInitialized(){this.input.setAttribute("type","text"),this.input.setAttribute("placeholder","Cardholder Name"),this.input.setAttribute("maxLength","30")}validate(e){return/^\w+\s+.*\w{2,}$/.test(e)?{valid:!0}:/^\w+/.test(e)||/^\w+\s+/.test(e)||/^\w+\s+\w/.test(e)?{valid:"maybe",error:"Invalid name"}:{valid:!1,error:"Invalid name"}}}t.FieldFrameName=i},853:(e,t)=>{var r,n,a,i;Object.defineProperty(t,"__esModule",{value:!0}),t.Deployment=t.CountryCode=t.CardType=t.FieldType=void 0,function(e){e.Name="name",e.Number="number",e.Year="year",e.Month="month",e.Cvv="cvv",e.PostalCode="postalcode"}(r||(t.FieldType=r={})),function(e){e.Unknown="unknown",e.Visa="visa",e.Mastercard="mastercard",e.AmericanExpress="american-express",e.DinersClub="diners-club",e.Discover="discover",e.Jcb="jcb",e.UnionPay="unionpay",e.Maestro="maestro",e.Mir="mir",e.Elo="elo",e.Hiper="hiper",e.HiperCard="hipercard"}(n||(t.CardType=n={})),function(e){e.US="US",e.CA="CA",e.AU="AU"}(a||(t.CountryCode=a={})),function(e){e.Local="local",e.Stage="stage",e.Prod="prod"}(i||(t.Deployment=i={}))},870:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.postalCode=void 0;var r=new RegExp(/^[a-z0-9]+$/i);function n(e,t){return{isValid:e,isPotentiallyValid:t}}t.postalCode=function(e,t){void 0===t&&(t={});var a=t.minLength||3;return"string"!=typeof e?n(!1,!1):e.length<a?n(!1,!0):r.test(e.trim().slice(0,a))?n(!0,!0):n(!1,!0)}},876:e=>{e.exports=function(e){for(var t,r=0,n=!1,a=e.length-1;a>=0;)t=parseInt(e.charAt(a),10),n&&(t*=2)>9&&(t=t%10+1),n=!n,r+=t,a--;return r%10==0}},887:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},938:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.currencyUnformat=t.numberUnformat=t.unmaskNumber=void 0;const n=r(394);t.unmaskNumber=e=>{const t=e.replace(/\D/g,"");let r=0;return r=parseFloat(t),r},t.numberUnformat=(e,t)=>{const r=new Intl.NumberFormat(t).formatToParts(1111.1);return a(e,r)},t.currencyUnformat=(e,t=navigator.language,r=n.currencyLocale[t.slice(-2)])=>{var i;const s=new Intl.NumberFormat(t,{style:"currency",currency:r}).formatToParts(1111.1),o=null===(i=s.find((({type:e})=>"currency"===e)))||void 0===i?void 0:i.value,c=o?e.replace(o,""):e;return a(c,s)};const a=(e,t)=>{var r,n;const a=null===(r=t.find((e=>"group"===e.type)))||void 0===r?void 0:r.value,i=null===(n=t.find((e=>"decimal"===e.type)))||void 0===n?void 0:n.value;return a&&(e=e.replace(a,"")),i&&(e=e.replace(i,".")),Number.isNaN(e)?NaN:parseFloat(e)}},961:function(e,t,r){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},n.apply(this,arguments)},a=r(83),i=r(209),s=r(664),o=r(101),c=r(788),d={},l={VISA:"visa",MASTERCARD:"mastercard",AMERICAN_EXPRESS:"american-express",DINERS_CLUB:"diners-club",DISCOVER:"discover",JCB:"jcb",UNIONPAY:"unionpay",MAESTRO:"maestro",ELO:"elo",MIR:"mir",HIPER:"hiper",HIPERCARD:"hipercard"},p=[l.VISA,l.MASTERCARD,l.AMERICAN_EXPRESS,l.DINERS_CLUB,l.DISCOVER,l.JCB,l.UNIONPAY,l.MAESTRO,l.ELO,l.MIR,l.HIPER,l.HIPERCARD],u=(0,c.clone)(p);function h(e){return d[e]||a[e]}function y(e,t){void 0===t&&(t=!1);var r=u.indexOf(e);if(!t&&-1===r)throw new Error('"'+e+'" is not a supported card type.');return r}function f(e){var t=[];if(!(0,s.isValidInputType)(e))return t;if(0===e.length)return u.map((function(e){return(0,c.clone)(h(e))}));u.forEach((function(r){var n=h(r);(0,i.addMatchingCardsToResults)(e,n,t)}));var r=(0,o.findBestMatch)(t);return r?[r]:t}f.getTypeInfo=function(e){return(0,c.clone)(h(e))},f.removeCard=function(e){var t=y(e);u.splice(t,1)},f.addCard=function(e){var t=y(e.type,!0);d[e.type]=e,-1===t&&u.push(e.type)},f.updateCard=function(e,t){var r=d[e]||a[e];if(!r)throw new Error('"'.concat(e,"\" is not a recognized type. Use `addCard` instead.'"));if(t.type&&r.type!==t.type)throw new Error("Cannot overwrite type parameter.");var i=(0,c.clone)(r);i=n(n({},i),t),d[i.type]=i},f.changeOrder=function(e,t){var r=y(e);u.splice(r,1),u.splice(t,0,e)},f.resetModifications=function(){u=(0,c.clone)(p),d={}},f.types=l,e.exports=f},979:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FieldFrame=void 0;const n=r(134),a=r(327),i=r(118);var s;!function(e){e[e.Key=0]="Key",e[e.FocusOut=1]="FocusOut",e[e.Collect=2]="Collect",e[e.FieldValueChanged=3]="FieldValueChanged"}(s||(s={}));class o{constructor(e,t,r,a=new n.CssModifier){this._fieldType=e,this._formKey=t,this._formOrigin=r,this.cssModifier=a,this.fieldValues={},this.isValid=!1,this.gotInitializeMessage=!1,this._placeholderVisible=!0,this._placeholderOverride=null,this._windowListener=e=>this.handleFormMessage(e),this.channel=new BroadcastChannel(o.channelName+t),this.channel.addEventListener("message",(e=>this.handleChannelMessage(e.data))),window.addEventListener("message",this._windowListener)}get fieldType(){return this._fieldType}get formKey(){return this._formKey}get formOrigin(){return this._formOrigin}get input(){return this._input}get config(){return this._config}getFieldValue(e){return this.fieldValues[e]}getFieldValueData(){}postChannelMessage(e){this.channel.postMessage(e)}onInitialized(e){}validate(e){return{valid:!1}}postFormMessage(e){window.parent.postMessage(e,this.formOrigin)}set placeholder(e){this._placeholder=e,this.updatePlaceholder()}get placeholder(){return this._placeholder}updatePlaceholder(){var e;this._placeholderVisible?this.input.setAttribute("placeholder",null!==(e=this._placeholderOverride)&&void 0!==e?e:this._placeholder):this.input.removeAttribute("placeholder")}handleFormMessage(e){if(e.origin!==this.formOrigin)return;const t=e.data;switch(t.type){case"initialize":this.handleFieldInitializeMessage(t);break;case"style":this.handleFieldStyleMessage(t);break;case"collect":this.handleFieldBeginCollectMessage(t);break;case"focus":this.input.focus()}}handleFieldInitializeMessage(e){this.gotInitializeMessage?console.warn(`Field ${this.fieldType} is already initialized.`):(this.gotInitializeMessage=!0,e.config.customFonts&&this.injectCustomFonts(e.config.customFonts),this.container=document.getElementById("container"),this._input=document.getElementById("input"),this.error=document.getElementById("error"),this.container.className=this.fieldType,this._input.addEventListener("keyup",(e=>this.handleDomKeyUp(e))),this._input.addEventListener("focusin",(()=>this.handleDomFocusIn())),this._input.addEventListener("focusout",(()=>this.handleDomFocusOut())),this.postFormMessage({type:"initialized"}),this._config=e.config,this.onInitialized(this._config))}injectCustomFonts(e){(0,a.validateCustomFonts)(e);for(const t of e)if("font-file"===t.type){const e=document.createElement("style");e.textContent=`@font-face { font-family: '${t.familyName}'; src: url('${t.url}'); }`,document.head.appendChild(e)}else if("css-import"===t.type){const e=document.createElement("link");e.rel="stylesheet",e.href=t.url,document.head.appendChild(e)}}handleFieldStyleMessage(e){if(void 0!==e.placeholderVisible&&(this._placeholderVisible=e.placeholderVisible),void 0!==e.placeholderText&&(this._placeholderOverride=e.placeholderText),this.updatePlaceholder(),e.updates)for(const[t,r]of Object.entries(e.updates)){const e=o.styleTargetSelectorTexts[t];e?this.cssModifier.modify(e,r):console.warn(`No selector text for ${t}`)}}handleFieldBeginCollectMessage(e){this.fieldType===a.FieldTypeValues[a.FieldTypeValues.length-1]?(this.collectOptions=e.options,this.postChannelMessage({target:a.FieldTypeValues[0],message:{type:"collect",data:{},anyInvalid:!1}})):console.error(`Field ${this.fieldType} cannot begin collecting`)}handleChannelMessage(e){if("all"===e.target||e.target===this.fieldType)switch(e.message.type){case"collect":this.handleChannelCollectMessage(e.message);break;case"valueChanged":this.handleChannelValueChangedMessage(e.message)}}handleChannelCollectMessage(e){!0===this.validatePrivate(s.Collect).valid?e.data[this.fieldType]=this.input.value:""!==this.input.value&&(e.anyInvalid=!0);const t=a.FieldTypeValues.indexOf(this.fieldType);t===a.FieldTypeValues.length-1?this.finishCollection(e.data,e.anyInvalid):this.postChannelMessage({target:a.FieldTypeValues[t+1],message:e})}handleChannelValueChangedMessage(e){this.fieldValues[e.field]=e.info,this.validatePrivate(s.FieldValueChanged)}handleDomFocusIn(){this.postFormMessage({type:"focus",hasFocus:!0})}handleDomFocusOut(){this.postFormMessage({type:"focus",hasFocus:!1}),this.validatePrivate(s.FocusOut)}handleDomKeyUp(e){var t;1===(null===(t=e.key)||void 0===t?void 0:t.length)&&this.validatePrivate(s.Key)}validatePrivate(e){var t;const r=this.isValid,n=this.validate(this.input.value),a=n.valid&&n.complete&&e===s.Key;this.isValid=!0===n.valid,!0===n.valid||"maybe"===n.valid&&e===s.Key?(this.error.innerHTML="&nbsp;",this.container.classList.remove("error")):e!==s.Collect&&""===this.input.value||(this.error.innerText=null!==(t=n.error)&&void 0!==t?t:"Enter a valid value",this.container.classList.add("error"));let i=!1;return(r!==this.isValid||a)&&(this.postFormMessage({type:"valid",valid:this.isValid,complete:a}),i=!0),(i||e===s.Key)&&this.postChannelMessage({target:"all",message:{type:"valueChanged",field:this.fieldType,info:{value:this.input.value,data:this.getFieldValueData(),valid:this.isValid}}}),n}finishCollection(e,t){const r=a.FieldTypeValues.filter((t=>!e[t]));if(r.length)return void this.postUnsuccessfulCollectResult(t?"invalidData":"missingData",t?"Some card data is invalid.":"Some card data is missing.",`Missing/invalid fields: ${r.join(", ")}`);if(!this.collectOptions)return void this.postUnsuccessfulCollectResult("unexpectedError","An unexpected error occurred. Please try again.",`finishCollection() called on a field (${this.fieldType}) with no collectOptions.`);let n;"legacy"===this.collectOptions.mode?(n=new i.LegacyCollector(this.config.deployment,this.collectOptions),n.collect(e).then((e=>this.postFormMessage({type:"collectResult",result:e}))).catch((e=>this.postUnsuccessfulCollectResult("unexpectedError","An unexpected error occurred. Please try again.",e.toString())))):this.postUnsuccessfulCollectResult("unexpectedError","An unexpected error occurred. Please try again.",`unknown collectOptions.mode: ${this.collectOptions.mode}`)}postUnsuccessfulCollectResult(e,t,r){this.postFormMessage({type:"collectResult",result:{mode:this.collectOptions.mode,success:!1,errorCode:e,error:t,errorDetails:r}})}}t.FieldFrame=o,o.styleTargetSelectorTexts={body:"body",container:"#container","container.focus":"#container:focus-within","container.error":"#container.error",input:"#input","input.focus":"#input:focus","input.error":"#container.error #input",error:"#error"},o.channelName="FieldFrames"},985:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isArray=void 0,t.isArray=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)}},997:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FormEventManagerImpl=void 0,t.FormEventManagerImpl=class{constructor(e){this.eventHandlers={},e.postEvent=(e,t)=>this.postEvent(e,t)}subscribe(e,t){var r,n;const a=Math.random();return null!==(r=(n=this.eventHandlers)[e])&&void 0!==r||(n[e]={}),this.eventHandlers[e][a]=t,{unsubscribe:()=>{delete this.eventHandlers[e][a]}}}postEvent(e,t){var r;for(const n of Object.values(null!==(r=this.eventHandlers[t.type])&&void 0!==r?r:{}))n(t,e)}}}},t={};function r(n){var a=t[n];if(void 0!==a)return a.exports;var i=t[n]={exports:{}};return e[n].call(i.exports,i,i.exports,r),i.exports}return r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r(156)})()));